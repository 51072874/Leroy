<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapa Leroy Merlin - One Page SpotX</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>

  <style>
    html, body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    body {
      position: relative;
      font-family: "Roboto", Arial, sans-serif;
      overflow: hidden;
    }

    #viewDiv {
      height: 100%;
      width: 100%;
    }

    /* ---------- Estilos do card de filtros ---------- */
    :root {
      --primary: #1976d2;
      --surface: #fff;
      --border: #dcdcdc;
      --shadow: 0 8px 28px rgba(0, 0, 0, 0.12);
    }

    #filterCard {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 10;
      max-width: 380px;
    }

    .card {
      background: var(--surface);
      padding: 18px;
      border-radius: 14px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
      font-size: 13px;
    }

    select,
    .dropdown-btn {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-panel {
      display: none;
      position: absolute;
      width: 100%;
      left: 0;
      top: calc(100% + 6px);
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      max-height: 260px;
      overflow-y: auto;
      box-shadow: var(--shadow);
      z-index: 9999;
      padding: 10px;
      box-sizing: border-box;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
    }

    .item:hover {
      background: #eef4ff;
    }

    .controls {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .controls button {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fafafa;
      cursor: pointer;
      font-size: 12px;
    }

    .footer {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }

    .btn-primary {
      flex: 1;
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }

    .btn-clear {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <!-- Mapa -->
  <div id="viewDiv"></div>

  <!-- Card de filtros sobreposto no canto superior esquerdo -->
  <div id="filterCard" class="card">
    <h3>Filtros Avançados</h3>

    <label>Loja</label>
    <select id="selLoja"></select>

    <label>Seção</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelSecao')">
        <span id="lblSecao">Selecionar...</span> <span id="cntSecao">0</span>
      </div>
      <div class="dropdown-panel" id="panelSecao">
        <div class="controls">
          <button type="button" onclick="selectAll('secao')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('secao')">Limpar</button>
        </div>
        <div id="listSecao"></div>
      </div>
    </div>

    <label>Canal</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelCanal')">
        <span id="lblCanal">Selecionar...</span> <span id="cntCanal">0</span>
      </div>
      <div class="dropdown-panel" id="panelCanal">
        <div class="controls">
          <button type="button" onclick="selectAll('canal')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('canal')">Limpar</button>
        </div>
        <div id="listCanal"></div>
      </div>
    </div>

    <label>Ano</label>
    <select id="selAno"></select>

    <label>Mês</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelMes')">
        <span id="lblMes">Selecionar...</span> <span id="cntMes">0</span>
      </div>
      <div class="dropdown-panel" id="panelMes">
        <div class="controls">
          <button type="button" onclick="selectAll('mes')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('mes')">Limpar</button>
        </div>
        <div id="listMes"></div>
      </div>
    </div>

    <div class="footer">
      <button type="button" class="btn-primary" onclick="aplicar()">Aplicar</button>
      <button type="button" class="btn-clear" onclick="limpar()">Limpar</button>
    </div>
  </div>

  <script>
    /*******************************************************
     * URLs
     *******************************************************/
    const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
    const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
    const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
    const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

    /*******************************************************
     * Estado dos filtros (sempre string / array de string)
     *******************************************************/
    let dataset = [];
    let state = { loja: "", secao: [], canal: [], ano: "", mes: [] };

    /*******************************************************
     * Variáveis de mapa / camadas
     *******************************************************/
    let map, view;
    let bairrosLayer, zonasLayer, lojasLayer, vendasLayer;

    /*******************************************************
     * Pequena sanitização para strings de where
     *******************************************************/
    const sanitize = v => v ? String(v).replace(/'/g, "''") : null;

    function buildIn(field, values) {
      const arr = (values || []).filter(Boolean).map(v => `'${sanitize(v)}'`);
      if (!arr.length) return null;
      if (arr.length === 1) return `${field}=${arr[0]}`;
      return `${field} IN (${arr.join(",")})`;
    }

    /*******************************************************
     * ArcGIS + OAuth + inicialização
     *******************************************************/
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager"
    ], function (Map, MapView, FeatureLayer, OAuthInfo, IdentityManager) {

      /* ------------------- LOGIN OAUTH ------------------- */
    //   const info = new OAuthInfo({
    //     appId: "6oEhKdonlPthGMTc",
    //     popup: false,
    //     portalUrl: "https://igeo.leroymerlin.com.br/portal"
    //   });
    //   IdentityManager.registerOAuthInfos([info]);
    //   IdentityManager.getCredential("https://igeo.leroymerlin.com.br/portal/sharing");

      /* ------------------- MAPA ------------------- */
      map = new Map({ basemap: "streets-navigation-vector" });

      view = new MapView({
        container: "viewDiv",
        map,
        center: [-55, -14], // Brasil
        zoom: 3
      });

      bairrosLayer = new FeatureLayer({
        url: BAIRROS_URL,
        outFields: ["*"],
        visible: false,
        labelingInfo: [{
          labelExpressionInfo: { expression: "$feature.nome_bairr" },
          symbol: { type: "text", color: "#000", font: { size: 8 } },
          labelPlacement: "always-horizontal",
          deconflictionStrategy: "dynamic"
        }]
      });

      zonasLayer = new FeatureLayer({
        url: ZONAS_URL,
        outFields: ["*"],
        visible: false,
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-fill",
            color: [0, 0, 0, 0],
            outline: { color: "#EE861F", width: 2 }
          }
        }
      });

      lojasLayer = new FeatureLayer({
        url: LOJAS_URL,
        outFields: ["*"],
        visible: false
      });

      vendasLayer = new FeatureLayer({
        url: VENDAS_URL,
        outFields: ["secao", "id_canal_venda", "ano", "mes", "id_loja_venda"]
      });

      map.addMany([bairrosLayer, zonasLayer, lojasLayer]);

      /* ------------------- CARREGAR LOJAS PARA FILTRO ------------------- */
      lojasLayer.queryFeatures({
        where: "1=1",
        outFields: ["cod_loja", "nome_loja"],
        returnGeometry: false
      }).then(res => {
        const sel = document.getElementById("selLoja");
        sel.innerHTML = `<option value="">-- Selecionar --</option>`;
        res.features.forEach(f => {
          sel.innerHTML += `<option value="${f.attributes.cod_loja}">
            ${f.attributes.cod_loja} - ${f.attributes.nome_loja}
          </option>`;
        });

        // Se vier cod_loja pela URL, opcionalmente podemos aplicar
        const params = new URLSearchParams(window.location.search);
        const codLojaURL = params.get("cod_loja");
        if (codLojaURL) {
          state.loja = codLojaURL;
          sel.value = codLojaURL;
        }

        sel.onchange = () => {
          state.loja = sel.value;
          atualizarFiltros();
        };
      });

      /* ------------------- CARREGAR TABELA 8 PARA DOMÍNIOS ------------------- */
      vendasLayer.queryFeatures({
        where: "1=1",
        outFields: ["secao", "id_canal_venda", "ano", "mes", "id_loja_venda"],
        returnGeometry: false
      }).then(res => {
        dataset = res.features.map(f => f.attributes);

        // Se vierem parâmetros de URL (secao, canal, ano, mes), opcionalmente inicia estado
        const params = new URLSearchParams(window.location.search);
        const secaoURL = params.get("secao");
        const canalURL = params.get("id_canal_venda");
        const anoURL   = params.get("ano");
        const mesURL   = params.get("mes");

        if (secaoURL) state.secao = secaoURL.split(",").filter(Boolean);
        if (canalURL) state.canal = canalURL.split(",").filter(Boolean);
        if (anoURL)   state.ano   = anoURL;
        if (mesURL)   state.mes   = mesURL.split(",").filter(Boolean);

        montarFiltrosIniciais();
      });

    });

    /*******************************************************
     * LÓGICA DOS FILTROS (somente DOM + dataset)
     *******************************************************/
    function montarFiltrosIniciais() {
      atualizarFiltros();
    }

    function atualizarFiltros() {
      if (!dataset.length) return;

      let filtrado = dataset.filter(r => {
        if (state.loja && r.id_loja_venda != state.loja) return false;
        if (state.ano && r.ano != state.ano) return false;
        if (state.secao.length && !state.secao.includes(r.secao)) return false;
        if (state.canal.length && !state.canal.includes(r.id_canal_venda)) return false;
        if (state.mes.length && !state.mes.includes(r.mes)) return false;
        return true;
      });

      const secoes = [...new Set(filtrado.map(r => r.secao))].filter(Boolean).sort();
      const canais = [...new Set(filtrado.map(r => r.id_canal_venda))].filter(Boolean).sort();
    //   const meses  = [...new Set(filtrado.map(r => r.mes))].filter(Boolean).sort();
      const meses = ["1","2","3","4","5","6","7","8","9","10","11","12"];

      const anos   = [...new Set(filtrado.map(r => r.ano))].filter(Boolean).sort();

      renderDomain("secao", secoes);
      renderDomain("canal", canais);
      renderDomain("mes",   meses);
      renderAnos(anos);
    }

    function renderDomain(field, values) {
      const list = document.getElementById("list" + capitalize(field));
      const selected = state[field];

      list.innerHTML = "";

      values.forEach(v => {
        const checked = selected.includes(v) ? "checked" : "";
        list.innerHTML += `
          <label class="item">
            <input type="checkbox" value="${v}" ${checked}
              onchange="toggleValue('${field}', this.value, this.checked)">
            ${v}
          </label>`;
      });

      atualizarLabels();
    }

    function renderAnos(values) {
      const selAno = document.getElementById("selAno");
      selAno.innerHTML = `<option value="">-- Todos --</option>`;

      values.forEach(v => {
        selAno.innerHTML += `<option value="${v}">${v}</option>`;
      });

      selAno.value = state.ano;

      selAno.onchange = () => {
        state.ano = selAno.value;
        atualizarFiltros();
      };
    }

    function toggleValue(field, value, checked) {
      if (checked) {
        if (!state[field].includes(value)) state[field].push(value);
      } else {
        state[field] = state[field].filter(v => v !== value);
      }
      atualizarLabels();
    }

    function selectAll(field) {
      const list = document.querySelectorAll(`#list${capitalize(field)} input`);
      state[field] = [...list].map(i => i.value);
      renderDomain(field, state[field]);
    }

    function clearAll(field) {
      state[field] = [];
      renderDomain(field, []);
    }

    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function atualizarLabels() {
      document.getElementById("cntSecao").textContent = state.secao.length;
      document.getElementById("lblSecao").textContent =
        state.secao.length ? `${state.secao.length} selecionados` : "Selecionar...";

      document.getElementById("cntCanal").textContent = state.canal.length;
      document.getElementById("lblCanal").textContent =
        state.canal.length ? `${state.canal.length} selecionados` : "Selecionar...";

      document.getElementById("cntMes").textContent = state.mes.length;
      document.getElementById("lblMes").textContent =
        state.mes.length ? `${state.mes.length} selecionados` : "Selecionar...";
    }

    /*******************************************************
     * Dropdown
     *******************************************************/
    function openPanel(event, id) {
      event.stopPropagation();
      document.querySelectorAll(".dropdown-panel").forEach(p => p.style.display = "none");
      const el = document.getElementById(id);
      if (el) el.style.display = "block";
    }

    document.addEventListener("click", () => {
      document.querySelectorAll(".dropdown-panel").forEach(p => p.style.display = "none");
    });

    /*******************************************************
     * Aplicar / Limpar
     *******************************************************/
    function aplicar() {
      const payload = {
        loja: state.loja,
        secao: state.secao.join(","),
        canal: state.canal.join(","),
        ano: state.ano,
        mes: state.mes.join(",")
      };

      console.log("Filtros aplicados:", payload);

      // Atualiza o mapa local
      atualizarMapaComFiltros();

      // Mantém compatibilidade para uso dentro do Experience Builder (iframe)
      try {
        window.parent.postMessage(
          { type: "EXB_FILTER", data: payload },
          "https://igeo.leroymerlin.com.br"
        );
      } catch (e) {
        console.warn("postMessage falhou (provavelmente fora do EXB):", e);
      }
    }

    function limpar() {
      state = { loja: "", secao: [], canal: [], ano: "", mes: [] };
      document.getElementById("selLoja").value = "";
      document.getElementById("selAno").value = "";
      montarFiltrosIniciais();

      // Opcionalmente limpa o mapa
      if (bairrosLayer && zonasLayer && lojasLayer) {
        bairrosLayer.visible = false;
        zonasLayer.visible   = false;
        lojasLayer.visible   = false;
      }
    }

    /*******************************************************
     * Integração com o MAPA
     *******************************************************/
    async function atualizarMapaComFiltros() {
      if (!state.loja) {
        console.warn("Selecione uma loja para aplicar no mapa.");
        return;
      }

      if (!bairrosLayer || !zonasLayer || !lojasLayer || !vendasLayer || !view) {
        console.warn("Camadas ainda não carregadas.");
        return;
      }

      const codLoja = state.loja;

      // Ajusta definição das camadas de mapa
      bairrosLayer.definitionExpression = `cod_loja_zinflu='${sanitize(codLoja)}'`;
      zonasLayer.definitionExpression   = `COD_LOJA='${sanitize(codLoja)}'`;
      lojasLayer.definitionExpression   = `cod_loja='${sanitize(codLoja)}'`;

      // Verificar se a loja existe
      const qLoja = lojasLayer.createQuery();
      qLoja.where = `cod_loja='${sanitize(codLoja)}'`;
      const rLoja = await lojasLayer.queryFeatures(qLoja);

      if (!rLoja.features.length) {
        console.warn("Loja não encontrada.");
        bairrosLayer.visible = false;
        zonasLayer.visible   = false;
        lojasLayer.visible   = false;
        return;
      }

      bairrosLayer.visible = true;
      zonasLayer.visible   = true;
      lojasLayer.visible   = true;

      // Processar bairros e vendas
      processarBairrosEVendas();
    }

    async function processarBairrosEVendas() {
      const codLoja = state.loja;
      if (!codLoja) return;

      // 1) Buscar bairros da loja
      const q = bairrosLayer.createQuery();
      q.where = `cod_loja_zinflu='${sanitize(codLoja)}'`;
      q.returnGeometry = true;
      q.outFields = ["cod_bairro"];

      const bairros = await bairrosLayer.queryFeatures(q);

      if (!bairros.features.length) {
        console.warn("Nenhum bairro encontrado para a loja.");
        return;
      }

      // Ajusta extensão do mapa
      view.goTo(bairros.features.map(f => f.geometry.extent));

      // Monta lista de IDs de bairros
      const listaIDs = bairros.features
        .map(f => `'${sanitize(f.attributes.cod_bairro)}'`)
        .join(",");

      // 2) Montar filtros pra tabela de vendas (camada 8)
      const filtros = [];

      const exprSecao = buildIn("secao", state.secao);
      if (exprSecao) filtros.push(exprSecao);

      const exprCanal = buildIn("id_canal_venda", state.canal);
      if (exprCanal) filtros.push(exprCanal);

      if (state.ano) {
        filtros.push(`ano='${sanitize(state.ano)}'`);
      }

      const exprMes = buildIn("mes", state.mes);
      if (exprMes) filtros.push(exprMes);

      const filtroExtra = filtros.length ? " AND " + filtros.join(" AND ") : "";

      const qv = vendasLayer.createQuery();
      qv.where = `id_bairro_cep IN (${listaIDs})${filtroExtra}`;
      qv.outFields = [
        "id_bairro_cep",
        "valor_vendas_atual",
        "valor_vendas_anterior"
      ];

      console.log("WHERE vendas aplicado:", qv.where);

      const vendasData = await vendasLayer.queryFeatures(qv);

      const progresso = {};

      vendasData.features.forEach(f => {
        const a = Number(f.attributes.valor_vendas_atual) || 0;
        const b = Number(f.attributes.valor_vendas_anterior) || 0;
        let pct = 0;
        if (b !== 0) pct = ((a / b) - 1) * 100;
        progresso[f.attributes.id_bairro_cep] = pct;
      });

      // 3) Renderer dinâmico com Arcade
      bairrosLayer.renderer = {
        type: "simple",
        symbol: { type: "simple-fill", outline: { color: "#777", width: 0.5 } },
        visualVariables: [{
          type: "color",
          valueExpression: `
            var pg = ${JSON.stringify(progresso)};
            var v = pg[$feature.cod_bairro];
            return DefaultValue(v, 0);
          `,
          stops: [
            { value: -20, color: "rgba(192,0,0,.3)" },
            { value: -10, color: "rgba(255,63,63,.3)" },
            { value: 0,   color: "rgba(244,146,75,.3)" },
            { value: 10,  color: "rgba(127,255,255,.3)" },
            { value: 20,  color: "rgba(0,192,192,.3)" },
            { value: 100, color: "rgba(0,128,128,.3)" }
          ]
        }]
      };

      bairrosLayer.refresh();
    }
  </script>
</body>
</html>
