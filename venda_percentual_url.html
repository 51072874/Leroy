<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

#container {
  position: relative;
  height: 100%;
  width: 100%;
}

#loader {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.8);
  z-index: 10;
}

.spinner {
  width: 42px;
  height: 42px;
  border: 4px solid #ddd;
  border-top-color: #2b7cff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

canvas {
  width: 100% !important;
  height: 100% !important;
}

#nodata {
  display: none;
  position: absolute;
  inset: 0;
  align-items: center;
  justify-content: center;
  font: 14px system-ui;
  color: #666;
}
</style>
</head>

<body>
<div id="container">
  <div id="loader"><div class="spinner"></div></div>
  <canvas id="chart"></canvas>
  <div id="nodata">Nenhum dado para os filtros selecionados</div>
</div>

<script>
// Configurações e constantes
const LAYER_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  classe: "classe_social",
  valor: "valor_vendas_atual"
};

const CLASS_COLORS = {
  "A1": "#0B2C3D",
  "A2": "#1F4E66",
  "B1": "#2E6B3F",
  "B2": "#6FAF8E",
  "C1": "#F2D36B",
  "C2": "#F6E8B1",
  "D/E": "#D9D9D9"
};

const collator = new Intl.Collator("pt-BR", { numeric: true, sensitivity: "base" });

// Estado de filtros
let state = {
  loja: [],
  mes: [],
  ano: [],
  secao: [],
  id_canal_venda: []
};

// Funções auxiliares
function showLoader(on) {
  document.getElementById("loader").style.display = on ? "flex" : "none";
}

function parseList(name) {
  const qs = new URLSearchParams(window.location.search);
  if (!qs.has(name)) return [];
  const raw = qs.get(name);
  if (!raw || raw.trim() === "" || raw.includes("{") || raw.toLowerCase() === "null" || raw.toLowerCase() === "undefined") {
    return [];
  }
  return raw.split(",").map(v => v.trim()).filter(v => v !== "");
}

function applyFiltersFromEB(filters) {
  state.loja = toArray(filters.loja);
  state.mes = toArray(filters.mes);
  state.ano = toArray(filters.ano);
  state.secao = toArray(filters.secao);
  state.id_canal_venda = toArray(filters.id_canal_venda);
  load();
}

function toArray(v) {
  if (!v) return [];
  if (Array.isArray(v)) return v.map(String);
  return String(v).split(",").map(s => s.trim()).filter(Boolean);
}

// Montagem do WHERE
function buildWhere() {
  const parts = ["1=1"];

  if (state.loja.length)
    parts.push(`id_loja_venda IN (${state.loja.map(v => `'${v}'`).join(",")})`);

  if (state.mes.length)
    parts.push(`mes IN (${state.mes.map(v => `'${v}'`).join(",")})`);

  if (state.ano.length)
    parts.push(`ano IN (${state.ano.map(v => `'${v}'`).join(",")})`);

  if (state.id_canal_venda.length)
    parts.push(`id_canal_venda IN (${state.id_canal_venda.map(v => `'${v}'`).join(",")})`);

  if (state.secao.length)
    parts.push(`secao IN (${state.secao.map(v => `'${v}'`).join(",")})`);

  return parts.join(" AND ");
}

// Requisição para o FeatureServer
async function esriQuery(params) {
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

  const r = await fetch(url.toString());
  const j = await r.json();

  if (!r.ok || j.error) throw j.error || { message: "Erro na query" };
  return j;
}

// Exibição de porcentagem
function fmtPctBR(n) {
  if (!isFinite(n)) return "0,00%";
  return n.toFixed(2).replace(".", ",") + "%";
}

// Plugin para adicionar labels aos valores
const valueLabelsPlugin = {
  id: "valueLabelsPlugin",
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data.datasets[0].data || [];

    ctx.save();
    ctx.font = "12px system-ui";
    ctx.fillStyle = "#222";
    ctx.textBaseline = "middle";

    meta.data.forEach((bar, i) => {
      const v = data[i]?.x ?? 0;
      ctx.fillText(fmtPctBR(v), bar.x + 8, bar.y);
    });

    ctx.restore();
  }
};

// Inicialização do gráfico
const chart = new Chart(document.getElementById("chart"), {
  type: "bar",
  data: {
    datasets: [{
      data: [],
      backgroundColor: [],
      borderWidth: 0,
      barThickness: 25
    }]
  },
  options: {
    indexAxis: "y",
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    parsing: { xAxisKey: "x", yAxisKey: "y" },
    layout: { padding: { right: 70 } },
    scales: {
      x: {
        beginAtZero: true,
        grid: { display: false },
        ticks: {
          callback: v => v + "%"
        }
      },
      y: {
        grid: { display: false },
        ticks: { autoSkip: false }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  },
  plugins: [valueLabelsPlugin]
});

// Carregar dados e atualizar gráfico
async function load() {
  showLoader(true);

  try {
    const where = buildWhere();

    const byClass = await esriQuery({
      f: "json",
      where,
      outFields: FIELDS.classe,
      groupByFieldsForStatistics: FIELDS.classe,
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: FIELDS.valor, outStatisticFieldName: "SUM_V" }
      ]),
      returnGeometry: "false"
    });

    const totalQ = await esriQuery({
      f: "json",
      where,
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: FIELDS.valor, outStatisticFieldName: "TOTAL" }
      ]),
      returnGeometry: "false"
    });

    const total = totalQ.features?.[0]?.attributes?.TOTAL || 0;

    const rows = (byClass.features || [])
      .map(f => ({
        classe: String(f.attributes[FIELDS.classe] || "").trim(),
        valor: Number(f.attributes.SUM_V || 0)
      }))
      .filter(r => r.classe);

    if (!rows.length || total === 0) {
      document.getElementById("nodata").style.display = "flex";
      chart.data.datasets[0].data = [];
      chart.update();
    } else {
      document.getElementById("nodata").style.display = "none";
      rows.sort((a, b) => collator.compare(a.classe, b.classe));
      chart.data.datasets[0].data = rows.map(r => ({
        y: r.classe,
        x: (r.valor / total) * 100
      }));

      chart.data.datasets[0].backgroundColor =
        rows.map(r => CLASS_COLORS[r.classe] || "#999");

      chart.options.scales.x.max =
        Math.ceil(Math.max(...rows.map(r => (r.valor / total) * 100)) / 5) * 5;

      chart.update();
    }
  } catch (e) {
    console.error("Erro:", e);
  } finally {
    showLoader(false);
  }
}

// Escutar filtros enviados pelo Experience Builder
window.addEventListener("message", (evt) => {
  const msg = evt.data || {};
  if (msg.type === "EXB_SET_FILTER") {
    applyFiltersFromEB(msg.filters || {});
  }
});

// Carregar filtros da URL (se existirem)
function loadFromURL() {
  const qs = new URLSearchParams(window.location.search);
  applyFiltersFromEB({
    loja: qs.get("loja"),
    mes: qs.get("mes"),
    ano: qs.get("ano"),
    secao: qs.get("secao"),
    id_canal_venda: qs.get("id_canal_venda")
  });
}

loadFromURL();
</script>
</body>
</html>
