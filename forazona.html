<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
 
<style>

html, body{

  margin:0;

  padding:0;

  height:100%;

  background:#fff;

  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;

}
 
#container{

  position:relative;

  height:100%;

  width:100%;

  display:flex;

  align-items:stretch;

  justify-content:center;

  padding:10px;

  box-sizing:border-box;

}
 
/* ===== LOADER: somente o circulo, fundo branco, escondendo conteúdo ===== */

#loader{

  position:absolute;

  inset:0;

  display:flex;

  align-items:center;

  justify-content:center;

  background:transparent;  /* mantém branco */

  z-index:10;

  pointer-events:none;

}
 
.spinner{

  width:42px;

  height:42px;

  border:4px solid #e5e5e5;

  border-top-color:#2b7cff;

  border-radius:50%;

  animation:spin 1s linear infinite;

}
 
@keyframes spin { to { transform:rotate(360deg); } }
 
#content{

  width:100%;

  height:100%;

}
 
/* quando estiver carregando, some com cabeçalho e valores */

.loading #content{

  visibility:hidden;

}
 
/* ===== KPI layout ===== */

.kpiWrap{

  width:100%;

  height:100%;

  display:grid;

  grid-template-columns: repeat(3, 1fr);

  border-radius:10px;

  overflow:hidden;

  background:#fff;

  border:1px solid #e6e6e6;

}
 
.kpi{

  display:flex;

  flex-direction:column;

  justify-content:center;

  align-items:center;

  text-align:center;

  padding:14px 16px;

  box-sizing:border-box;

  background:#fff;

  min-width:0;

}
 
.kpi + .kpi{

  border-left:2px solid #cfcfcf;

}
 
.kpiTitle{

  font-size:12px;

  font-weight:650;

  color:#444;

  margin:0 0 10px 0;

  white-space:nowrap;

  overflow:hidden;

  text-overflow:ellipsis;

  width:100%;

}
 
.kpiValue{

  font-size:28px;

  font-weight:700;

  color:#333;

  line-height:1.1;

  display:flex;

  align-items:baseline;

  justify-content:center;

  gap:6px;

}
 
.kpiUnit{

  font-size:16px;

  font-weight:650;

  color:#666;

}
 
@media (max-width: 600px){

  .kpiWrap{ grid-template-columns: 1fr; }

  .kpi + .kpi{

    border-left:none;

    border-top:2px solid #cfcfcf;

  }

  .kpiValue{ font-size:26px; }

}
</style>
</head>
 
<body class="loading">
<div id="container">
<div id="loader"><div class="spinner"></div></div>
 
  <div id="content">
<div class="kpiWrap">
<div class="kpi">
<div class="kpiTitle">Vendas Brutas</div>
<div class="kpiValue">
<span class="kpiUnit">R$</span>
<span id="vAtual">—</span>
</div>
</div>
 
      <div class="kpi">
<div class="kpiTitle">Vendas Brutas</div>
<div class="kpiValue">
<span id="vPct">—</span>
<span class="kpiUnit">%</span>
</div>
</div>
 
      <div class="kpi">
<div class="kpiTitle">Progressao</div>
<div class="kpiValue">
<span id="vProg">—</span>
<span class="kpiUnit">%</span>
</div>
</div>
</div>
</div>
</div>
 
<script>

/* ================= CONFIG ================= */

const LAYER_URL =

  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";
 
const FIELDS = {

  loja: "id_loja_venda",

  mes: "mes",

  ano: "ano",

  canal: "id_canal_venda",

  secao: "secao",

  valorAtual: "valor_vendas_atual",

  valorAnterior: "valor_vendas_anterior"

};
 
const qs = new URLSearchParams(window.location.search);
 
/* ================= UTIL ================= */

function showLoader(on){

  document.getElementById("loader").style.display = on ? "flex" : "none";

  document.body.classList.toggle("loading", on);

}
 
function escapeSqlString(s){

  return String(s).replace(/'/g, "''");

}
 
function parseList(name){

  if (!qs.has(name)) return [];

  return String(qs.get(name) || "")

    .split(",")

    .map(v => v.trim())

    .filter(v => v !== "");

}
 
/**

* where normal: aplica todos filtros

* whereSemMes: remove apenas o filtro do mes, mantendo o resto

*/

function buildWhere(removeMes=false){

  const parts = ["1=1"];
 
  const lojas  = parseList("loja");

  const meses  = parseList("mes");

  const anos   = parseList("ano");

  const canais = parseList("id_canal_venda");

  const secoes = parseList("secao");
 
  if (lojas.length)

    parts.push(`${FIELDS.loja} IN (${lojas.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
 
  if (!removeMes && meses.length)

    parts.push(`${FIELDS.mes} IN (${meses.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
 
  if (anos.length)

    parts.push(`${FIELDS.ano} IN (${anos.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
 
  if (canais.length)

    parts.push(`${FIELDS.canal} IN (${canais.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
 
  if (secoes.length)

    parts.push(`${FIELDS.secao} IN (${secoes.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
 
  return parts.join(" AND ");

}
 
async function esriQuery(params){

  const url = new URL(LAYER_URL.replace(/\/+$/,"") + "/query");

  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));

  const r = await fetch(url.toString());

  const j = await r.json();

  if (!r.ok || j.error) throw (j.error || { message: `HTTP ${r.status}` });

  return j;

}
 
/* formatos */

function fmtBR(n){

  if (!isFinite(n)) n = 0;

  return Number(n).toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

}

function fmtPct(n){

  if (!isFinite(n)) n = 0;

  return Number(n).toFixed(2).replace(".", ",");

}
 
/* ================= LOAD ================= */

async function load(){

  showLoader(true);
 
  const whereSel    = buildWhere(false); // com mes

  const whereSemMes = buildWhere(true);  // sem filtro de mes
 
  // 1) Total atual/ant COM seleção (inclui mes)

  const selQ = await esriQuery({

    f: "json",

    where: whereSel,

    outStatistics: JSON.stringify([

      { statisticType: "sum", onStatisticField: FIELDS.valorAtual, outStatisticFieldName: "TOTAL_ATUAL_SEL" },

      { statisticType: "sum", onStatisticField: FIELDS.valorAnterior, outStatisticFieldName: "TOTAL_ANT_SEL" }

    ]),

    returnGeometry: "false"

  });
 
  // 2) Total atual SEM filtro de mes (mantém os outros filtros)

  const allQ = await esriQuery({

    f: "json",

    where: whereSemMes,

    outStatistics: JSON.stringify([

      { statisticType: "sum", onStatisticField: FIELDS.valorAtual, outStatisticFieldName: "TOTAL_ATUAL_ALL" }

    ]),

    returnGeometry: "false"

  });
 
  const aSel = selQ.features?.[0]?.attributes || {};

  const aAll = allQ.features?.[0]?.attributes || {};
 
  const totalAtualSel = Number(aSel.TOTAL_ATUAL_SEL || 0);

  const totalAntSel   = Number(aSel.TOTAL_ANT_SEL || 0);

  const totalAtualAll = Number(aAll.TOTAL_ATUAL_ALL || 0);
 
  // Vendas Brutas: total do filtro (inclui mes)

  document.getElementById("vAtual").textContent = fmtBR(totalAtualSel);
 
  // Vendas Brutas %: (total selecionado) / (total sem mes) * 100

  const pctMes = (totalAtualAll === 0) ? 0 : (totalAtualSel / totalAtualAll) * 100;

  document.getElementById("vPct").textContent = fmtPct(pctMes);
 
  // Progressao % (no recorte selecionado)

  const prog = (totalAntSel && totalAntSel !== 0) ? ((totalAtualSel / totalAntSel) - 1) * 100 : 0;

  document.getElementById("vProg").textContent = fmtPct(prog);
 
  showLoader(false);

}
 
load();
</script>
</body>
</html>

 
