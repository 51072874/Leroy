<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Filtros SpotX - Experience Builder</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: transparent;
    }

    #filterCard {
      width: 360px;
      padding: 16px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }

    h3 { margin: 0 0 8px 0; font-size: 16px; }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 700;
      font-size: 13px;
    }

    select, .dropdown-btn {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .dropdown { position: relative; }

    .dropdown-panel {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px;
      max-height: 240px;
      overflow-y: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      z-index: 99;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
    }

    .item:hover { background: #f1f7ff; }

    .controls {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .controls button {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      font-size: 12px;
    }

    .footer {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-primary {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      background: #1976d2;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }

    .btn-clear {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e0e0e0;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div id="filterCard">
    <h3>Filtros Avançados</h3>

    <label>Loja</label>
    <select id="selLoja"></select>

    <label>Seção</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelSecao')">
        <span id="lblSecao">Selecionar...</span> (<span id="cntSecao">0</span>)
      </div>
      <div class="dropdown-panel" id="panelSecao">
        <div class="controls">
          <button onclick="selectAll('secao')">Selecionar tudo</button>
          <button onclick="clearAll('secao')">Limpar</button>
        </div>
        <div id="listSecao"></div>
      </div>
    </div>

    <label>Canal</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelCanal')">
        <span id="lblCanal">Selecionar...</span> (<span id="cntCanal">0</span>)
      </div>
      <div class="dropdown-panel" id="panelCanal">
        <div class="controls">
          <button onclick="selectAll('canal')">Selecionar tudo</button>
          <button onclick="clearAll('canal')">Limpar</button>
        </div>
        <div id="listCanal"></div>
      </div>
    </div>

    <label>Ano</label>
    <select id="selAno"></select>

    <label>Mês</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelMes')">
        <span id="lblMes">Selecionar...</span> (<span id="cntMes">0</span>)
      </div>
      <div class="dropdown-panel" id="panelMes">
        <div class="controls">
          <button onclick="selectAll('mes')">Selecionar tudo</button>
          <button onclick="clearAll('mes')">Limpar</button>
        </div>
        <div id="listMes"></div>
      </div>
    </div>

    <div class="footer">
      <button class="btn-primary" onclick="aplicar()">Aplicar</button>
      <button class="btn-clear" onclick="limpar()">Limpar</button>
    </div>
  </div>

<script>
const LOJAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const VENDAS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

let dataset = [];
let state = { loja: "", secao: [], canal: [], ano: "", mes: [] };

function openPanel(event,id){
  event.stopPropagation();
  const el=document.getElementById(id);
  const aberto=el.style.display==="block";
  document.querySelectorAll(".dropdown-panel").forEach(p=>p.style.display="none");
  if(!aberto)el.style.display="block";
}

document.addEventListener("click",()=>document.querySelectorAll(".dropdown-panel").forEach(p=>p.style.display="none"));

function atualizarLabels(){
  document.getElementById("cntSecao").textContent = state.secao.length;
  document.getElementById("cntCanal").textContent = state.canal.length;
  document.getElementById("cntMes").textContent   = state.mes.length;
}

function toggleValue(field,value,checked){
  value=String(value);
  if(checked && !state[field].includes(value)) state[field].push(value);
  if(!checked) state[field]=state[field].filter(v=>v!==value);
  atualizarLabels();
}

function selectAll(field){
  document.querySelectorAll(`#list${field[0].toUpperCase()+field.slice(1)} input`).forEach(i=>i.checked=true);
  state[field]=[...document.querySelectorAll(`#list${field[0].toUpperCase()+field.slice(1)} input`)].map(i=>i.value);
  atualizarLabels();
}

function clearAll(field){
  state[field]=[];
  document.querySelectorAll(`#list${field[0].toUpperCase()+field.slice(1)} input`).forEach(i=>i.checked=false);
  atualizarLabels();
}

function aplicar(){
  const p=new URLSearchParams();
  if(state.loja) p.set("cod_loja",state.loja);
  if(state.secao.length) p.set("secao",state.secao.join(","));
  if(state.canal.length) p.set("id_canal_venda",state.canal.join(","));
  if(state.ano) p.set("ano",state.ano);
  if(state.mes.length) p.set("mes",state.mes.join(","));
  window.parent.location.href = window.location.origin + window.location.pathname + "?" + p.toString();
}

function limpar(){
  state={loja:"",secao:[],canal:[],ano:"",mes:[]};
  document.querySelectorAll("select").forEach(s=>s.value="");
  document.querySelectorAll("input[type=checkbox]").forEach(i=>i.checked=false);
  atualizarLabels();
}

fetch(`${VENDAS_URL}/query?where=1=1&outFields=*&returnGeometry=false&f=json`)
  .then(r=>r.json()).then(res=>{
    dataset=res.features.map(f=>f.attributes);
    const anos=[...new Set(dataset.map(r=>r.ano))].sort();
    selAno.innerHTML='<option value="">-- Todos --</option>';
    anos.forEach(a=>selAno.innerHTML+=`<option>${a}</option>`);
  });

renderMes();
function renderMes(){
  const m=["1","2","3","4","5","6","7","8","9","10","11","12"];
  listMes.innerHTML="";
  m.forEach(v=>listMes.innerHTML+=`<label class='item'><input type='checkbox' value='${v}' onchange="toggleValue('mes',this.value,this.checked)"> ${v}</label>`);
}
</script>
</body>
</html>
