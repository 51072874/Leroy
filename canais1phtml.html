<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --bg:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --pad:10px;
}
html, body{
  margin:0;
  padding:0;
  height:100%;
  width:100%;
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  overflow:hidden;
}
*{ box-sizing:border-box; }

.titleBar{
  width:100%;
  background:#6FAFB3;
  color:#ffffff;
  text-align:center;
  font-weight:600;
  font-size:14px;
  padding:6px 0;
}

#container{
  height:100%;
  width:100%;
  padding:var(--pad);
  display:flex;
  flex-direction:column;
  gap:8px;
}

.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}

.topRow{
  display:flex;
  gap:16px;
  align-items:center;
}

.chartBox{
  width:260px;
  height:260px;
}

svg{ width:100%; height:100%; overflow:visible; }

.legend{
  display:flex;
  gap:14px;
  font-size:11px;
}

.legItem{
  display:flex;
  gap:6px;
  align-items:center;
}

.swatch{
  width:12px;
  height:12px;
  border-radius:3px;
}

.tableBox{
  border:1px solid #d1d5db;
  border-radius:6px;
  overflow:hidden;
}

table{
  border-collapse:collapse;
  font-size:11px;
}

th,td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
}

th{ background:#f9fafb; text-align:left; }
td:last-child, th:last-child{ text-align:right; }

.pctLabel{
  font-size:9px;
  font-weight:600;
  fill:#111827;
}

.line{
  stroke:#6b7280;
  stroke-width:0.6;
}
</style>
</head>

<body>
<div id="container">
  <div class="titleBar">Canais 1P</div>

  <div class="wrap">
    <div class="topRow">
      <div class="chartBox">
        <svg id="donut" viewBox="0 0 100 100"></svg>
      </div>

      <div class="tableBox">
        <table>
          <thead>
            <tr><th>Canal</th><th>Prog %</th></tr>
          </thead>
          <tbody id="progBody"></tbody>
        </table>
      </div>
    </div>

    <div class="legend" id="legend"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  codZ: "cod_loja_zinflu2",
  valorAtual: "valor_vendas_atual",
  valorAnterior: "valor_vendas_anterior"
};

const qs = new URLSearchParams(window.location.search);

const CANAL_LABEL = {
  "0": "E-commerce",
  "1": "Loja Física",
  "2": "Televendas"
};

/* ✅ ÚNICA CORREÇÃO: cores DIFERENTES */
const CANAL_COLOR = {
  "0": "#1F5A78", // E-commerce
  "1": "#0B2E3F", // Loja Física
  "2": "#F28C38"  // Televendas
};

/* ================= UTIL ================= */

function escapeSqlString(s){
  return String(s).replace(/'/g, "''");
}

function parseList(name){
  if (!qs.has(name)) return [];
  return qs.get(name).split(",").map(v=>v.trim()).filter(Boolean);
}

function buildWhere(){
  const p = ["1=1", `${FIELDS.codZ} IS NOT NULL`, `${FIELDS.codZ} <> '0'`];

  const map = {
    loja:FIELDS.loja,
    mes:FIELDS.mes,
    ano:FIELDS.ano,
    id_canal_venda:FIELDS.canal,
    secao:FIELDS.secao
  };

  Object.entries(map).forEach(([q,f])=>{
    const v = parseList(q);
    if(v.length) p.push(`${f} IN (${v.map(x=>`'${escapeSqlString(x)}'`).join(",")})`);
  });

  return p.join(" AND ");
}

async function esriQuery(params){
  const url = new URL(LAYER_URL+"/query");
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url);
  const j = await r.json();
  if(j.error) throw j.error;
  return j;
}

function fmt(n){ return n.toFixed(2).replace(".",",")+"%"; }

/* ================= LOAD ================= */

(async ()=>{
  const where = buildWhere();

  const totalQ = await esriQuery({
    f:"json",
    where,
    outStatistics:JSON.stringify([
      { statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"T" }
    ]),
    returnGeometry:false
  });

  const total = totalQ.features[0].attributes.T;

  const byCanalQ = await esriQuery({
    f:"json",
    where,
    groupByFieldsForStatistics:FIELDS.canal,
    outStatistics:JSON.stringify([
      { statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"A" },
      { statisticType:"sum", onStatisticField:FIELDS.valorAnterior, outStatisticFieldName:"B" }
    ]),
    returnGeometry:false
  });

  const data = byCanalQ.features.map(f=>{
    const c = String(f.attributes[FIELDS.canal]);
    return {
      canal:c,
      label:CANAL_LABEL[c],
      atual:f.attributes.A,
      ant:f.attributes.B,
      color:CANAL_COLOR[c]
    };
  });

  /* ===== DONUT ===== */
  const svg = document.getElementById("donut");
  const cx=50, cy=50, rO=42, rI=26;

  let angle=-90;

  data.forEach(d=>{
    const pct=d.atual/total;
    const delta=pct*360;

    const a0=angle*Math.PI/180;
    const a1=(angle+delta)*Math.PI/180;

    const path=document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("fill",d.color);
    path.setAttribute("d",`
      M ${cx+rO*Math.cos(a1)} ${cy+rO*Math.sin(a1)}
      A ${rO} ${rO} 0 ${delta>180?1:0} 0 ${cx+rO*Math.cos(a0)} ${cy+rO*Math.sin(a0)}
      L ${cx+rI*Math.cos(a0)} ${cy+rI*Math.sin(a0)}
      A ${rI} ${rI} 0 ${delta>180?1:0} 1 ${cx+rI*Math.cos(a1)} ${cy+rI*Math.sin(a1)}
      Z
    `);
    svg.appendChild(path);

    const mid=angle+delta/2;
    const rad=mid*Math.PI/180;

    const x1=cx+rO*Math.cos(rad);
    const y1=cy+rO*Math.sin(rad);
    const x2=cx+(rO+8)*Math.cos(rad);
    const y2=cy+(rO+8)*Math.sin(rad);
    const x3=x2+(Math.cos(rad)>0?6:-6);

    const line=document.createElementNS("http://www.w3.org/2000/svg","polyline");
    line.setAttribute("points",`${x1},${y1} ${x2},${y2} ${x3},${y2}`);
    line.setAttribute("class","line");
    line.setAttribute("fill","none");
    svg.appendChild(line);

    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",x3+(Math.cos(rad)>0?2:-2));
    txt.setAttribute("y",y2);
    txt.setAttribute("text-anchor",Math.cos(rad)>0?"start":"end");
    txt.setAttribute("dominant-baseline","middle");
    txt.setAttribute("class","pctLabel");
    txt.textContent=(pct*100).toFixed(1).replace(".",",")+"%";
    svg.appendChild(txt);

    angle+=delta;
  });

  /* ===== LEGENDA ===== */
  const legend=document.getElementById("legend");
  data.forEach(d=>{
    legend.innerHTML+=`
      <div class="legItem">
        <span class="swatch" style="background:${d.color}"></span>
        <span>${d.label}</span>
      </div>`;
  });

  /* ===== TABELA ===== */
  const tb=document.getElementById("progBody");
  data.forEach(d=>{
    const prog=((d.atual-d.ant)/d.ant)*100;
    tb.innerHTML+=`
      <tr>
        <td>${d.label}</td>
        <td>${fmt(prog)}</td>
      </tr>`;
  });
})();
</script>
</body>
</html>
