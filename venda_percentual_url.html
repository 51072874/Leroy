<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

#container {
  position: relative;
  height: 100%;
  width: 100%;
}

#loader {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.8);
  z-index: 10;
}

.spinner {
  width: 42px;
  height: 42px;
  border: 4px solid #ddd;
  border-top-color: #2b7cff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

canvas {
  width: 100% !important;
  height: 100% !important;
}

#nodata {
  display: none;
  position: absolute;
  inset: 0;
  align-items: center;
  justify-content: center;
  font: 14px system-ui;
  color: #666;
}
</style>
</head>

<body>
<div id="container">
  <div id="loader"><div class="spinner"></div></div>
  <canvas id="chart"></canvas>
  <div id="nodata">Nenhum dado para os filtros selecionados</div>
</div>

<script>
// Configura√ß√µes e constantes
const LAYER_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

let FILTERS = {
  mes: [],
  ano: [],
  secao: [],
  id_canal_venda: [],
  loja: []
};
  
const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  classe: "classe_social",
  valor: "valor_vendas_atual"
};

const CLASS_COLORS = {
  "A1": "#0B2C3D",
  "A2": "#1F4E66",
  "B1": "#2E6B3F",
  "B2": "#6FAF8E",
  "C1": "#F2D36B",
  "C2": "#F6E8B1",
  "D/E": "#D9D9D9"
};

const collator = new Intl.Collator("pt-BR", { numeric: true, sensitivity: "base" });

// Fun√ß√µes auxiliares
function showLoader(on) {
  document.getElementById("loader").style.display = on ? "flex" : "none";
}

function toArray(v) {
  if (!v) return [];
  if (Array.isArray(v)) return v.map(String);
  return String(v).split(",").map(s => s.trim()).filter(Boolean);
}

// Montagem do WHERE
function buildWhere() {
  const parts = ["1=1"];

  if (FILTERS.mes.length)
    parts.push(`mes IN (${FILTERS.mes.map(v => `'${v}'`).join(",")})`);

  if (FILTERS.ano.length)
    parts.push(`ano IN (${FILTERS.ano.map(v => `'${v}'`).join(",")})`);

  if (FILTERS.secao.length)
    parts.push(`secao IN (${FILTERS.secao.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);

  if (FILTERS.id_canal_venda.length)
    parts.push(`id_canal_venda IN (${FILTERS.id_canal_venda.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);

  if (FILTERS.loja.length)
    parts.push(`id_loja_venda IN (${FILTERS.loja.map(v => `'${v}'`).join(",")})`);

  const whereFinal = parts.join(" AND ");
  console.log("üß© WHERE FINAL:", whereFinal);

  return whereFinal;
}

// Requisi√ß√£o para o FeatureServer
async function esriQuery(params) {
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

  const r = await fetch(url.toString());
  const j = await r.json();

  if (!r.ok || j.error) throw j.error || { message: "Erro na query" };
  return j;
}

// Exibi√ß√£o de porcentagem
function fmtPctBR(n) {
  if (!isFinite(n)) return "0,00%";
  return n.toFixed(2).replace(".", ",") + "%";
}

// Plugin para adicionar labels aos valores
const valueLabelsPlugin = {
  id: "valueLabelsPlugin",
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data.datasets[0].data || [];

    ctx.save();
    ctx.font = "12px system-ui";
    ctx.fillStyle = "#222";
    ctx.textBaseline = "middle";

    meta.data.forEach((bar, i) => {
      const v = data[i]?.x ?? 0;
      ctx.fillText(fmtPctBR(v), bar.x + 8, bar.y);
    });

    ctx.restore();
  }
};

// Inicializa√ß√£o do gr√°fico
const chart = new Chart(document.getElementById("chart"), {
  type: "bar",
  data: {
    datasets: [{
      data: [],
      backgroundColor: [],
      borderWidth: 0,
      barThickness: 25
    }]
  },
  options: {
    indexAxis: "y",
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    parsing: { xAxisKey: "x", yAxisKey: "y" },
    layout: { padding: { right: 70 } },
    scales: {
      x: {
        beginAtZero: true,
        grid: { display: false },
        ticks: {
          callback: v => v + "%"
        }
      },
      y: {
        grid: { display: false },
        ticks: { autoSkip: false }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  },
  plugins: [valueLabelsPlugin]
});

// Carregar dados e atualizar gr√°fico
async function load() {
  showLoader(true);

  try {
    const where = buildWhere();

    const byClass = await esriQuery({
      f: "json",
      where,
      outFields: FIELDS.classe,
      groupByFieldsForStatistics: FIELDS.classe,
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: FIELDS.valor, outStatisticFieldName: "SUM_V" }
      ]),
      returnGeometry: "false"
    });

    const totalQ = await esriQuery({
      f: "json",
      where,
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: FIELDS.valor, outStatisticFieldName: "TOTAL" }
      ]),
      returnGeometry: "false"
    });

    const total = totalQ.features?.[0]?.attributes?.TOTAL || 0;

    const rows = (byClass.features || [])
      .map(f => ({
        classe: String(f.attributes[FIELDS.classe] || "").trim(),
        valor: Number(f.attributes.SUM_V || 0)
      }))
      .filter(r => r.classe);

    if (!rows.length || total === 0) {
      document.getElementById("nodata").style.display = "flex";
      chart.data.datasets[0].data = [];
      chart.update();
    } else {
      document.getElementById("nodata").style.display = "none";
      rows.sort((a, b) => collator.compare(a.classe, b.classe));
      chart.data.datasets[0].data = rows.map(r => ({
        y: r.classe,
        x: (r.valor / total) * 100
      }));

      chart.data.datasets[0].backgroundColor =
        rows.map(r => CLASS_COLORS[r.classe] || "#999");

      chart.options.scales.x.max =
        Math.ceil(Math.max(...rows.map(r => (r.valor / total) * 100)) / 5) * 5;

      chart.update();
    }
  } catch (e) {
    console.error("Erro:", e);
  } finally {
    showLoader(false);
  }
}

// ============================================
// üî• LISTENER UNIFICADO - RECEBE FILTROS DO WIDGET
// ============================================
window.addEventListener("message", (event) => {
  const msg = event.data || {};
  
  console.log("üì® Mensagem recebida:", msg);
  
  // Aceita tanto EXB_SET_FILTER quanto SPOTX_FILTER_CHANGE
  if (msg.type === "EXB_SET_FILTER" || msg.type === "SPOTX_FILTER_CHANGE") {
    const filters = msg.filters || {};
    
    console.log("‚úÖ Filtros recebidos:", filters);
    
    // üî• CORRE√á√ÉO: Mapeia cod_loja ‚Üí loja
    FILTERS = {
      loja: toArray(filters.cod_loja || filters.loja),
      mes: toArray(filters.mes),
      ano: toArray(filters.ano),
      secao: toArray(filters.secao),
      id_canal_venda: toArray(filters.id_canal_venda)
    };
    
    console.log("üîß FILTERS ap√≥s convers√£o:", FILTERS);
    
    // Recarrega o gr√°fico
    load();
  }
});

// Carregar filtros da URL (se existirem)
function loadFromURL() {
  const qs = new URLSearchParams(window.location.search);
  
  FILTERS = {
    loja: toArray(qs.get("loja") || qs.get("cod_loja")),
    mes: toArray(qs.get("mes")),
    ano: toArray(qs.get("ano")),
    secao: toArray(qs.get("secao")),
    id_canal_venda: toArray(qs.get("id_canal_venda"))
  };
  
  console.log("üåê Filtros da URL:", FILTERS);
  
  load();
}

// Inicializa√ß√£o
loadFromURL();

console.log("‚úÖ Gr√°fico carregado e pronto para receber filtros");
</script>
</body>
</html>
