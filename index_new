<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8" />

<script>
  window["dojoConfig"] = {
    async: true
  };
</script>

<script src="https://js.arcgis.com/4.30/"></script>

<style>
  html, body, #viewDiv {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
  }
</style>

</head>

<body>

<div id="viewDiv"></div>

<script>
/* CONFIG */
var LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
var ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
var BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
var VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

/* PARÃ‚METROS */
var params = new URLSearchParams(window.location.search || "");
var codLoja = params.get("cod_loja");
var secao   = params.get("secao");
var idCanal = params.get("id_canal_venda");
var ano     = params.get("ano");
var mes     = params.get("mes");

if (codLoja === "0") codLoja = null;
function sanitize(v){ return v ? v.replace(/'/g,"''") : null; }
secao = sanitize(secao); 
idCanal = sanitize(idCanal);
ano = sanitize(ano);
mes = sanitize(mes);

/* ARCGIS API */
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function(Map, MapView, FeatureLayer) {

  var map = new Map({ basemap: "streets-navigation-vector" });

  var view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-55, -14],
    zoom: 3
  });

  if (!codLoja) return;

  var bairrosLayer = new FeatureLayer({
    url: BAIRROS_URL,
    outFields: ["*"],
    visible: false,
    definitionExpression: "cod_loja_zinflu='" + codLoja + "'"
  });

  var zonasLayer = new FeatureLayer({
    url: ZONAS_URL,
    outFields: ["*"],
    visible: false,
    definitionExpression: "COD_LOJA='" + codLoja + "'",
    renderer:{
      type:"simple",
      symbol:{
        type:"simple-fill",
        color:[0,0,0,0],
        outline:{ color:"#EE861F", width:2 }
      }
    }
  });

  var lojasLayer = new FeatureLayer({
    url: LOJAS_URL,
    outFields:["*"],
    visible:false,
    definitionExpression:"cod_loja='" + codLoja + "'"
  });

  map.addMany([bairrosLayer, zonasLayer, lojasLayer]);

  view.when(function() {
    lojasLayer.when(function() {

      var q = lojasLayer.createQuery();
      q.where = "cod_loja='" + codLoja + "'";

      lojasLayer.queryFeatures(q).then(function(r){

        if (!r.features.length) return;

        bairrosLayer.visible = true;
        zonasLayer.visible   = true;
        lojasLayer.visible   = true;

        processarBairrosEVendas();
      });
    });
  });

  function processarBairrosEVendas() {

    var q = bairrosLayer.createQuery();
    q.where = "cod_loja_zinflu='" + codLoja + "'";
    q.returnGeometry = true;
    q.outFields = ["cod_bairro"];

    bairrosLayer.queryFeatures(q).then(function(bairros){

      if (!bairros.features.length) return;

      var extents = bairros.features.map(function(f){ return f.geometry.extent; });
      view.goTo(extents).catch(function(){});

      var listaIDs = bairros.features
        .map(function(f){ return "'" + sanitize(f.attributes.cod_bairro) + "'"; })
        .join(",");

      var filtros = [];
      if (secao) filtros.push("secao='" + secao + "'");
      if (idCanal) filtros.push("id_canal_venda='" + idCanal + "'");
      if (ano) filtros.push("ano='" + ano + "'");
      if (mes) filtros.push("mes='" + mes + "'");

      var filtroExtra = filtros.length ? " AND " + filtros.join(" AND ") : "";

      var vendasLayer = new FeatureLayer({ url: VENDAS_URL });

      var qv = vendasLayer.createQuery();
      qv.where = "id_bairro_cep IN (" + listaIDs + ")" + filtroExtra;
      qv.outFields = [
        "id_bairro_cep",
        "valor_vendas_atual",
        "valor_vendas_anterior"
      ];

      vendasLayer.queryFeatures(qv).then(function(vendasData){

        var progresso = {};
        vendasData.features.forEach(function(f){
          var a = Number(f.attributes.valor_vendas_atual) || 0;
          var b = Number(f.attributes.valor_vendas_anterior) || 0;
          progresso[f.attributes.id_bairro_cep] = b === 0 ? 0 : ((a/b)-1)*100;
        });

        var pg = JSON.stringify(progresso);

        // expression Arcade sem template string
        var expression =
          "var pg = " + pg + ";" +
          "var v = pg[$feature.cod_bairro];" +
          "return DefaultValue(v,0);";

        bairrosLayer.renderer = {
          type: "simple",
          symbol: { type:"simple-fill", outline:{color:"#777", width:0.5} },
          visualVariables: [{
            type: "color",
            valueExpression: expression,
            stops: [
              {value:-20, color:"rgba(192,0,0,.3)"},
              {value:-10, color:"rgba(255,63,63,.3)"},
              {value:0,   color:"rgba(244,146,75,.3)"},
              {value:10,  color:"rgba(127,255,255,.3)"},
              {value:20,  color:"rgba(0,192,192,.3)"},
              {value:100, color:"rgba(0,128,128,.3)"}
            ]
          }]
        };

        bairrosLayer.refresh();
      });
    });
  }

});
</script>

</body>
</html>
