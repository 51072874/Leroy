<!doctype html>
<html lang="pt-br">
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --text:#111827;
  --muted:#6b7280;
  --bar:#4F7987;
  --barHover:#3F6673;
  --axis:#e5e7eb;
}
html,body{
  margin:0;
  height:100%;
  background:transparent;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
}
*{ box-sizing:border-box; }

#container{
  height:100%;
  padding:10px;
  display:flex;
  flex-direction:column;
}
.title{
  text-align:center;
  font-weight:600;
  font-size:14px;
  margin:0 0 10px 0;
}
#content{
  position:relative;
  flex:1;
  display:flex;
  flex-direction:column;
  gap:4px;
}

/* loader */
#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.spinner{
  width:36px;
  height:36px;
  border:4px solid #d1d5db;
  border-top-color:#2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* chart */
.chart{
  flex:1;
  display:flex;
  gap:8px;
}
.yAxis{
  width:46px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  padding-top:25px;
  padding-bottom:44px;
}
.yTick{
  font-size:10px;
  color:var(--muted);
  transform:translateY(50%);
}
.plot{
  flex:1;
  position:relative;
}
.bars{
  position:absolute;
  inset:0;
  display:flex;
  align-items:flex-end;
  gap:clamp(10px,2vw,16px);
  padding:10px 14px 14px 14px;
}
.barCol{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}
.barValue{
  font-size:11px;
}
.bar{
  width:min(54px,100%);
  background:var(--bar);
  border-radius:10px 10px 6px 6px;
}
.barLabel{
  font-size:11px;
  color:var(--muted);
  text-align:center;
}
</style>
</head>

<body>
<div id="container">
  <div class="title">PDM / PROG</div>

  <div id="content">
    <div id="loader"><div class="spinner"></div></div>

    <div class="chart" id="chart" style="display:none">
      <div class="yAxis" id="yAxis"></div>
      <div class="plot">
        <div class="bars" id="bars"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

const LAYER_PDM =
 "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/3";

const PDM_FIELDS = {
  isocrona: "isocrona",
  vendas: "vendas_brutas"
};

/* ================= UTIL ================= */

function esriQuery(url, params){
  const u=new URL(url+"/query");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  return fetch(u).then(r=>r.json());
}

function fmt1(n){return n.toFixed(1).replace(".",",");}
function fmt0(n){return Math.round(n);}

function niceStep(target){
  const pow=Math.pow(10,Math.floor(Math.log10(target)));
  const n=target/pow;
  if(n<=1)return 1*pow;
  if(n<=2)return 2*pow;
  if(n<=5)return 5*pow;
  return 10*pow;
}

function buildYAxis(max){
  const step=niceStep(max/5);
  const y=document.getElementById("yAxis");
  y.innerHTML="";
  for(let i=5;i>=0;i--){
    y.innerHTML+=`<div class="yTick">${fmt0(step*i)}%</div>`;
  }
}

/* ================= RENDER ================= */

function renderBars(rows){
  const bars=document.getElementById("bars");
  bars.innerHTML="";
  document.getElementById("chart").style.display="flex";

  const max=Math.max(...rows.map(r=>r.value));
  buildYAxis(max);

  rows.forEach(r=>{
    const col=document.createElement("div");
    col.className="barCol";
    col.innerHTML=`
      <div class="barValue">${fmt1(r.value)}%</div>
      <div class="bar" style="height:${12+(r.value/max)*220}px"></div>
      <div class="barLabel">${r.label}</div>
    `;
    bars.appendChild(col);
  });
}

/* ================= LOAD ================= */

async function load(){
  document.getElementById("loader").style.display="flex";

  /* 1️⃣ TOTAL REAL DA LOJA (SEM GROUP BY) */
  const totalQ = await esriQuery(LAYER_PDM,{
    f:"json",
    where:"vendas_brutas IS NOT NULL",
    outStatistics:JSON.stringify([{
      statisticType:"sum",
      onStatisticField:PDM_FIELDS.vendas,
      outStatisticFieldName:"TOTAL"
    }]),
    returnGeometry:false
  });

  const totalLoja =
    totalQ.features?.[0]?.attributes?.TOTAL || 0;

  /* 2️⃣ VENDAS POR ISÓCRONA */
  const pdm = await esriQuery(LAYER_PDM,{
    f:"json",
    where:"vendas_brutas IS NOT NULL",
    groupByFieldsForStatistics:PDM_FIELDS.isocrona,
    outStatistics:JSON.stringify([{
      statisticType:"sum",
      onStatisticField:PDM_FIELDS.vendas,
      outStatisticFieldName:"V"
    }]),
    outFields:PDM_FIELDS.isocrona,
    returnGeometry:false
  });

  const rows = (pdm.features||[])
    .map(f=>{
      const iso=f.attributes[PDM_FIELDS.isocrona];
      const v=Number(f.attributes.V||0);
      if(!iso||!v||!totalLoja) return null;
      return {
        label:iso,
        value:(v/totalLoja)*100
      };
    })
    .filter(Boolean);

  renderBars(rows);
  document.getElementById("loader").style.display="none";
}

load();
</script>
</body>
</html>
