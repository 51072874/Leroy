<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:transparent;
  overflow:hidden;
  font-family: Arial, Helvetica, sans-serif;
  color:#444;
}
#container{
  position:relative;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.spinner{
  width:22px;
  height:22px;
  border:3px solid #ddd;
  border-top-color:#2b7cff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
.loading #content{ visibility:hidden; }
.kpiWrap{
  max-width:520px;
  width:100%;
  display:grid;
  grid-template-columns:repeat(3,1fr);
}
.kpi{
  background:#e3e3e3;
  padding:10px;
  display:flex;
  justify-content:center;
}
.kpi + .kpi{ border-left:1px solid #fff; }
.kpiValue{ font-size:11px; font-weight:600; display:flex; gap:4px; }
</style>
</head>

<body class="loading">
<div id="container">
  <div id="loader"><div class="spinner"></div></div>

  <div id="content">
    <div class="kpiWrap">
      <div class="kpi"><div class="kpiValue"><span>R$</span><span id="vAtual">—</span></div></div>
      <div class="kpi"><div class="kpiValue"><span id="vPct">—</span><span>%</span></div></div>
      <div class="kpi"><div class="kpiValue"><span id="vProg">—</span><span>%</span></div></div>
    </div>
  </div>
</div>

<script>
const LAYER_URL =
 "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  codZ:"cod_loja_zinflu2",
  valorAtual:"valor_vendas_atual",
  valorAnterior:"valor_vendas_anterior"
};

let currentSQLWhere = "1=1";

window.addEventListener("message", e=>{
  if(e.data?.type==="SPOTX_FILTER_CHANGE" && e.data.filters?.sqlWhere){
    currentSQLWhere = e.data.filters.sqlWhere;
    load();
  }
});

function showLoader(on){
  document.getElementById("loader").style.display = on?"flex":"none";
  document.body.classList.toggle("loading",on);
}
function fmtBR(n){ return Number(n||0).toLocaleString("pt-BR",{minimumFractionDigits:2}); }
function fmtPct(n){ return Number(n||0).toFixed(2).replace(".",","); }

function removeMes(sql){
  return sql
    .replace(/\s*AND\s+mes\s+IN\s*\([^)]+\)/gi,'')
    .replace(/\s*AND\s+mes\s*=\s*'[^']+'/gi,'');
}

function whereSelecionado(){
  return `(${currentSQLWhere}) AND ${FIELDS.codZ} <> '0'`;
}
function whereTotalDentro(){
  return `(${removeMes(currentSQLWhere)}) AND ${FIELDS.codZ} <> '0'`;
}
function whereTotalFora(){
  return `(${removeMes(currentSQLWhere)}) AND ${FIELDS.codZ} = '0'`;
}

async function esriQuery(p){
  const u=new URL(LAYER_URL+"/query");
  Object.entries(p).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  const j=await r.json();
  if(j.error) throw j.error;
  return j;
}

async function load(){
  showLoader(true);
  try{
    const sel = await esriQuery({
      f:"json",
      where:whereSelecionado(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"A"},
        {statisticType:"sum",onStatisticField:FIELDS.valorAnterior,outStatisticFieldName:"B"}
      ]),
      returnGeometry:false
    });

    const dentro = await esriQuery({
      f:"json",
      where:whereTotalDentro(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"TD"}
      ]),
      returnGeometry:false
    });

    const fora = await esriQuery({
      f:"json",
      where:whereTotalFora(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"TF"}
      ]),
      returnGeometry:false
    });

    const A=+sel.features?.[0]?.attributes?.A||0;
    const B=+sel.features?.[0]?.attributes?.B||0;
    const TD=+dentro.features?.[0]?.attributes?.TD||0;
    const TF=+fora.features?.[0]?.attributes?.TF||0;

    const T=TD+TF;

    vAtual.textContent=fmtBR(A);
    vPct.textContent=fmtPct(T?(A/T)*100:0);
    vProg.textContent=fmtPct(B?((A-B)/B)*100:0);

  }catch(e){
    console.error(e);
  }
  showLoader(false);
}

load();
</script>
</body>
</html>
