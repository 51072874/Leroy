<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
/* ===== ESTILO ORIGINAL – SEM ALTERAÇÃO ===== */
:root{
  --bg:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --pad:10px;
}
html, body{
  margin:0;
  padding:0;
  height:100%;
  width:100%;
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  overflow:hidden;
}
*{ box-sizing:border-box; }
.titleBar{
  width:100%;
  background:#6FAFB3;
  color:#ffffff;
  text-align:center;
  font-weight:600;
  font-size:14px;
  padding:6px 0;
}
#container{
  position:relative;
  height:100%;
  width:100%;
  padding:var(--pad);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}
.wrap{
  width:100%;
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.topRow{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
}
.chartBox{
  width:240px;
  aspect-ratio:1/1;
}
svg{ width:100%; height:100%; overflow:visible; }
.legend{
  display:flex;
  gap:14px;
  font-size:11px;
}
.legItem{
  display:flex;
  gap:6px;
  align-items:center;
}
.swatch{
  width:12px;
  height:12px;
  border-radius:3px;
}
.tableBox{
  border:1px solid #d1d5db;
  border-radius:6px;
  overflow:hidden;
}
table{
  border-collapse:collapse;
  font-size:11px;
}
th,td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
}
th{ background:#f9fafb; text-align:left; }
td:last-child, th:last-child{ text-align:right; }
.pctLabel{
  font-size:10px;
  font-weight:600;
  fill:#111827;
}
</style>
</head>

<body>
<div id="container">
  <div class="titleBar">Canais 1P</div>

  <div class="wrap">
    <div class="topRow">
      <div class="chartBox">
        <svg id="donut" viewBox="0 0 100 100"></svg>
      </div>

      <div class="tableBox">
        <table>
          <thead>
            <tr>
              <th>Canal</th>
              <th>Prog %</th>
            </tr>
          </thead>
          <tbody id="progBody"></tbody>
        </table>
      </div>
    </div>

    <div class="legend" id="legend"></div>
  </div>
</div>

<script>
/* ===== CONFIG ORIGINAL – SEM ALTERAÇÃO ===== */

const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja:"id_loja_venda",
  mes:"mes",
  ano:"ano",
  canal:"id_canal_venda",
  secao:"secao",
  codZ:"cod_loja_zinflu2",
  valorAtual:"valor_vendas_atual",
  valorAnterior:"valor_vendas_anterior"
};

const qs = new URLSearchParams(window.location.search);

const CANAL_LABEL = {
  "0":"e-commerce",
  "1":"Loja Física",
  "2":"Televendas"
};

const COLORS = ["#1F5A78","#0B2E3F","#F28C38"];

/* ===== FUNÇÕES ORIGINAIS ===== */

function esc(s){ return String(s).replace(/'/g,"''"); }
function list(n){
  if(!qs.has(n)) return [];
  return qs.get(n).split(",").map(v=>v.trim()).filter(Boolean);
}
function buildWhere(){
  const p=["1=1",`${FIELDS.codZ} <> '0'`];
  const lojas=list("loja"), meses=list("mes"), anos=list("ano"), canais=list("id_canal_venda"), secoes=list("secao");
  if(lojas.length)  p.push(`${FIELDS.loja} IN (${lojas.map(v=>`'${esc(v)}'`).join(",")})`);
  if(meses.length)  p.push(`${FIELDS.mes} IN (${meses.map(v=>`'${esc(v)}'`).join(",")})`);
  if(anos.length)   p.push(`${FIELDS.ano} IN (${anos.map(v=>`'${esc(v)}'`).join(",")})`);
  if(canais.length) p.push(`${FIELDS.canal} IN (${canais.map(v=>`'${esc(v)}'`).join(",")})`);
  if(secoes.length) p.push(`${FIELDS.secao} IN (${secoes.map(v=>`'${esc(v)}'`).join(",")})`);
  return p.join(" AND ");
}
async function esriQuery(params){
  const u=new URL(LAYER_URL+"/query");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u); const j=await r.json();
  if(j.error) throw j.error;
  return j;
}
function fmtPct(n){
  return n.toFixed(1).replace(".",",")+"%";
}

/* ===== LOAD ===== */

(async function load(){
  const where=buildWhere();

  const totalQ=await esriQuery({
    f:"json",
    where,
    outStatistics:JSON.stringify([
      {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"T"}
    ]),
    returnGeometry:"false"
  });
  const total=+totalQ.features[0].attributes.T;

  const canalQ=await esriQuery({
    f:"json",
    where,
    groupByFieldsForStatistics:FIELDS.canal,
    outStatistics:JSON.stringify([
      {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"A"},
      {statisticType:"sum",onStatisticField:FIELDS.valorAnterior,outStatisticFieldName:"B"}
    ]),
    outFields:FIELDS.canal,
    returnGeometry:"false"
  });

  const rows=canalQ.features.map(f=>({
    canal:f.attributes[FIELDS.canal],
    atual:+f.attributes.A,
    ant:+f.attributes.B
  }));

  /* ===== TABELA – ÚNICA ALTERAÇÃO AQUI ===== */
  const tb=document.getElementById("progBody");
  rows.forEach(r=>{
    const prog = r.ant ? ((r.atual - r.ant) / r.ant) * 100 : 0; // <<< CORREÇÃO
    tb.innerHTML+=`
      <tr>
        <td>${CANAL_LABEL[r.canal]}</td>
        <td>${fmtPct(prog)}</td>
      </tr>`;
  });
})();
</script>
</body>
</html>
