<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapa Leroy Merlin</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
<div id="viewDiv"></div>
<script>
/*******************************************************
 * URLs
 *******************************************************/
const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";
/*******************************************************
 * Par창metros GET
 *******************************************************/
const params  = new URLSearchParams(window.location.search);
const codLoja = params.get("cod_loja");
const secao   = params.get("secao");
const idCanal = params.get("id_canal_venda");
const ano     = params.get("ano");
const mes     = params.get("mes");
if (!codLoja) alert("Par창metro ?cod_loja n찾o informado!");
/*******************************************************
 * MAPA
 *******************************************************/
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function(Map, MapView, FeatureLayer){
  const map = new Map({ basemap:"streets-navigation-vector" });
  const view = new MapView({
    container:"viewDiv",
    map,
    center:[-46.63,-23.55],
    zoom:11
  });
  /***************************************************
   * Camada Bairros
   ***************************************************/
  const bairrosLayer = new FeatureLayer({
    url:BAIRROS_URL,
    outFields:["*"],
    title:"Bairros",
    definitionExpression:`cod_loja_zinflu='${codLoja}'`,
    labelingInfo:[{
      labelExpressionInfo:{ expression:"$feature.nome_bairr" },
      symbol:{ type:"text", color:"#000", font:{ size:8 } },
      labelPlacement:"always-horizontal",
      deconflictionStrategy:"dynamic"
    }]
  });
  /***************************************************
   * Zonas
   ***************************************************/
  const zonasLayer = new FeatureLayer({
    url:ZONAS_URL,
    outFields:["*"],
    title:"Zona da Loja",
    definitionExpression:`COD_LOJA='${codLoja}'`,
    renderer:{
      type:"simple",
      symbol:{
        type:"simple-fill",
        color:[0,0,0,0],
        outline:{ color:"#EE861F", width:2 }
      }
    }
  });
  /***************************************************
   * Lojas
   ***************************************************/
  const lojasLayer = new FeatureLayer({
    url:LOJAS_URL,
    outFields:["*"],
    title:"Loja Selecionada",
    definitionExpression:`cod_loja='${codLoja}'`
  });
  map.addMany([bairrosLayer, zonasLayer, lojasLayer]);
  /***************************************************
   * Se n찾o existir loja -> mostrar Brasil
   ***************************************************/
  lojasLayer.when(async ()=>{
    const q = lojasLayer.createQuery();
    q.where=`cod_loja='${codLoja}'`;
    const r = await lojasLayer.queryFeatures(q);
    if(!r.features.length){
      bairrosLayer.visible=false;
      zonasLayer.visible=false;
      lojasLayer.visible=true;
      view.goTo({center:[-55,-14], zoom:4});
      return;
    }
    /***************************************************
     * Processar bairros+vendas
     ***************************************************/
    bairrosLayer.when(async ()=>{
      const q = bairrosLayer.createQuery();
      q.where=`cod_loja_zinflu='${codLoja}'`;
      q.returnGeometry=true;
      q.outFields=["cod_bairro"];
      const r = await bairrosLayer.queryFeatures(q);
      if(!r.features.length) return;
      view.goTo(r.features.map(f=>f.geometry.extent));
      const listaIDs = r.features.map(f=>`'${f.attributes.cod_bairro}'`).join(",");
      const vendasLayer = new FeatureLayer({ url:VENDAS_URL });
      /******** filtros **********/
      let filtros = [];
      if(secao)   filtros.push(`secao='${secao}'`);
      if(idCanal) filtros.push(`id_canal_venda='${idCanal}'`);
      if(ano)     filtros.push(`ano=${ano}`);
      if(mes)     filtros.push(`mes=${mes}`);
      const filtroExtra = filtros.length ? " AND "+filtros.join(" AND") : "";
      const qv = vendasLayer.createQuery();
      qv.where=`id_bairro_cep IN (${listaIDs})${filtroExtra}`;
      qv.outFields=[
        "id_bairro_cep",
        "valor_vendas_atual",
        "valor_vendas_anterior"
      ];
      const vendasData = await vendasLayer.queryFeatures(qv);
      const progresso={};
      vendasData.features.forEach(f=>{
        const a=f.attributes.valor_vendas_atual||0;
        const b=f.attributes.valor_vendas_anterior||0;
        let pct=0;
        if(b!==0) pct=((a/b)-1)*100;
        progresso[f.attributes.id_bairro_cep]=pct;
      });
      /******** renderer ********/
      bairrosLayer.renderer={
        type:"simple",
        symbol:{ type:"simple-fill", outline:{ color:"#777", width:0.5 } },
        visualVariables:[{
          type:"color",
          valueExpression:`
            var pg=${JSON.stringify(progresso)};
            var v=pg[$feature.cod_bairro];
            return DefaultValue(v,0);
          `,
          stops:[
            {value:-20, color:"rgba(192,0,0,.3)"},
            {value:-10, color:"rgba(255,63,63,.3)"},
            {value:0,   color:"rgba(244,146,75,.3)"},
            {value:10,  color:"rgba(127,255,255,.3)"},
            {value:20,  color:"rgba(0,192,192,.3)"},
            {value:100, color:"rgba(0,128,128,.3)"}
          ]
        }]
      };
      bairrosLayer.refresh();
    });
  });
});
</script>
</body>
</html>
