<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapa Leroy Merlin</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>
  <style>
    html, body, #viewDiv{
      padding:0;
      margin:0;
      height:100%;
      width:100%;
    }
  </style>
</head>
<body>
<div id="viewDiv"></div>

<script>
/*******************************************************
 * URLs
 *******************************************************/
const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

/*******************************************************
 * Parâmetros GET (loja=...)
 * Aceita multi para ano/mes: ?ano=2024,2025&mes=10,11
 *******************************************************/
const params = new URLSearchParams(window.location.search);

let codLoja = params.get("loja");
let secao   = params.get("secao");
let idCanal = params.get("id_canal_venda");
let ano     = params.get("ano");
let mes     = params.get("mes");

// Loja 0 = sem loja
if (codLoja === "0") codLoja = null;

// Sanitização mínima
const sanitize = v => (v == null ? null : String(v).replace(/'/g, "''").trim());

codLoja = sanitize(codLoja);
secao   = sanitize(secao);
idCanal = sanitize(idCanal);
ano     = sanitize(ano);
mes     = sanitize(mes);

/*******************************************************
 * Helpers multi (CSV) -> WHERE SEMPRE STRING (com aspas)
 * (isso corrige o problema do mes/ano não filtrarem)
 *******************************************************/
function splitCSV(v){
  if (!v) return [];
  return String(v)
    .split(",")
    .map(s => sanitize(s))
    .filter(s => s && s.toLowerCase() !== "null" && s.toLowerCase() !== "undefined");
}

function whereMultiStr(field, rawValue){
  const arr = splitCSV(rawValue);
  if (!arr.length) return null;

  if (arr.length === 1) return `${field}='${arr[0]}'`;

  const list = arr.map(v => `'${v}'`).join(",");
  return `${field} IN (${list})`;
}

/*******************************************************
 * Persistência de view (para NÃO voltar ao Brasil)
 *******************************************************/
const VIEW_KEY = "spotx_view_state_v1"; // { loja, center:[lon,lat], zoom }
let savedState = null;
try { savedState = JSON.parse(sessionStorage.getItem(VIEW_KEY) || "null"); } catch(e){ savedState = null; }
const sameLojaAsSaved = !!(codLoja && savedState && savedState.loja === codLoja);

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function(Map, MapView, FeatureLayer){

  const map = new Map({ basemap:"streets-navigation-vector" });

  // ✅ se já tem view salva dessa loja, inicia nela
  const initialCenter = (sameLojaAsSaved && savedState.center) ? savedState.center : [-55,-14];
  const initialZoom   = (sameLojaAsSaved && typeof savedState.zoom === "number") ? savedState.zoom : 3;

  const view = new MapView({
    container:"viewDiv",
    map,
    center: initialCenter,
    zoom: initialZoom
  });

  // ✅ salva center/zoom continuamente
  view.when(() => {
    view.watch(["center", "zoom"], () => {
      if (!codLoja) return;
      const c = view.center;
      if (!c) return;
      sessionStorage.setItem(VIEW_KEY, JSON.stringify({
        loja: codLoja,
        center: [Number(c.longitude), Number(c.latitude)],
        zoom: Number(view.zoom)
      }));
    });
  });

  if (!codLoja) {
    console.warn("Sem loja (loja ausente ou loja=0) → mapa somente com o Brasil.");
    return;
  }

  /***************************************************
   * Camadas
   ***************************************************/
  const bairrosLayer = new FeatureLayer({
    url: BAIRROS_URL,
    outFields: ["*"],
    visible: false,
    definitionExpression: `cod_loja_zinflu='${codLoja}'`,
    labelingInfo:[{
      labelExpressionInfo:{ expression:"$feature.nome_bairr" },
      symbol:{ type:"text", color:"#000", font:{ size:8 } },
      labelPlacement:"always-horizontal",
      deconflictionStrategy:"dynamic"
    }]
  });

  const zonasLayer = new FeatureLayer({
    url: ZONAS_URL,
    outFields: ["*"],
    visible: false,
    definitionExpression: `COD_LOJA='${codLoja}'`,
    renderer:{
      type:"simple",
      symbol:{
        type:"simple-fill",
        color:[0,0,0,0],
        outline:{ color:"#EE861F", width:2 }
      }
    }
  });

  const lojasLayer = new FeatureLayer({
    url: LOJAS_URL,
    outFields: ["*"],
    visible: false,
    definitionExpression: `cod_loja='${codLoja}'`
  });

  map.addMany([bairrosLayer, zonasLayer, lojasLayer]);

  /***************************************************
   * Verificar loja
   ***************************************************/
  lojasLayer.when(async () => {
    const q = lojasLayer.createQuery();
    q.where = `cod_loja='${codLoja}'`;

    const r = await lojasLayer.queryFeatures(q);
    if (!r.features.length) {
      console.warn("Loja não encontrada.");
      return;
    }

    bairrosLayer.visible = true;
    zonasLayer.visible   = true;
    lojasLayer.visible   = true;

    processarBairrosEVendas();
  });

  /***************************************************
   * Processamento completo
   ***************************************************/
  async function processarBairrosEVendas() {

    // 1) Bairros da ZI
    const q = bairrosLayer.createQuery();
    q.where = `cod_loja_zinflu='${codLoja}'`;
    q.returnGeometry = true;
    q.outFields = ["cod_bairro"];

    const bairros = await bairrosLayer.queryFeatures(q);
    if (!bairros.features.length) return;

    // ✅ Zoom só na 1ª vez da loja (se só mudar mes/ano/etc, mantém view)
    if (!sameLojaAsSaved) {
      await view.goTo(bairros.features.map(f => f.geometry.extent));
      const c = view.center;
      sessionStorage.setItem(VIEW_KEY, JSON.stringify({
        loja: codLoja,
        center: [Number(c.longitude), Number(c.latitude)],
        zoom: Number(view.zoom)
      }));
    }

    const listaIDs = bairros.features
      .map(f => `'${sanitize(f.attributes.cod_bairro)}'`)
      .join(",");

    /***************************************************
     * Montar filtros (STRING com aspas, inclusive ano/mes)
     ***************************************************/
    const filtros = [];

    const wSecao = whereMultiStr("secao", secao);
    const wCanal = whereMultiStr("id_canal_venda", idCanal);

    // ✅ Aqui está o fix principal:
    const wAno   = whereMultiStr("ano", ano);
    const wMes   = whereMultiStr("mes", mes);

    if (wSecao) filtros.push(wSecao);
    if (wCanal) filtros.push(wCanal);
    if (wAno)   filtros.push(wAno);
    if (wMes)   filtros.push(wMes);

    const filtroExtra = filtros.length ? " AND " + filtros.join(" AND ") : "";

    // 2) Consulta vendas filtradas
    const vendasLayer = new FeatureLayer({ url: VENDAS_URL });

    const qv = vendasLayer.createQuery();
    qv.where = `id_bairro_cep IN (${listaIDs})${filtroExtra}`;
    qv.outFields = [
      "id_bairro_cep",
      "valor_vendas_atual",
      "valor_vendas_anterior"
    ];

    console.log("WHERE final aplicado:", qv.where);

    const vendasData = await vendasLayer.queryFeatures(qv);

    /***************************************************
     * Progressão para multi mes/ano:
     * soma(atual) e soma(anterior) por bairro, depois:
     * pct = ((soma_atual / soma_anterior) - 1) * 100
     ***************************************************/
    const acc = {}; // { bairro: {a:sumAtual, b:sumAnterior} }

    vendasData.features.forEach(f => {
      const bairro = String(f.attributes.id_bairro_cep ?? "");
      if (!bairro) return;

      const a = Number(f.attributes.valor_vendas_atual) || 0;
      const b = Number(f.attributes.valor_vendas_anterior) || 0;

      if (!acc[bairro]) acc[bairro] = { a:0, b:0 };
      acc[bairro].a += a;
      acc[bairro].b += b;
    });

    const progresso = {};
    Object.keys(acc).forEach(bairro => {
      const A = acc[bairro].a;
      const B = acc[bairro].b;
      progresso[bairro] = (B !== 0) ? (((A / B) - 1) * 100) : 0;
    });

    // 3) Renderer
    bairrosLayer.renderer = {
      type:"simple",
      symbol:{ type:"simple-fill", outline:{ color:"#777", width:0.5 } },
      visualVariables:[{
        type:"color",
        valueExpression:`
          var pg = ${JSON.stringify(progresso)};
          var v = pg[$feature.cod_bairro];
          return DefaultValue(v,0);
        `,
        stops:[
          {value:-20, color:"rgba(192,0,0,.3)"},
          {value:-10, color:"rgba(255,63,63,.3)"},
          {value:0,   color:"rgba(244,146,75,.3)"},
          {value:10,  color:"rgba(127,255,255,.3)"},
          {value:20,  color:"rgba(0,192,192,.3)"},
          {value:100, color:"rgba(0,128,128,.3)"}
        ]
      }]
    };

    bairrosLayer.refresh();
  }

});
</script>
</body>
</html>
