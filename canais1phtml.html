<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --bg:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --pad:10px;
}
html, body{
  margin:0;
  padding:0;
  height:100%;
  width:100%;
  background:var(--bg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  overflow:hidden;
}
*{ box-sizing:border-box; }

.titleBar{
  width:100%;
  background:#6FAFB3;
  color:#ffffff;
  text-align:center;
  font-weight:600;
  font-size:14px;
  padding:6px 0;
}

#container{
  position:relative;
  height:100%;
  width:100%;
  padding:var(--pad);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
  pointer-events:none;
}
.spinner{
  width:32px;
  height:32px;
  border:4px solid #ddd;
  border-top-color:#2b7cff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }

.wrap{
  width:100%;
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
  opacity:0;
  pointer-events:none;
}

.topRow{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
}

.chartBox{
  width:220px;
  aspect-ratio:1/1;
}

svg{ width:100%; height:100%; }

.tableBox{
  width:220px;
  border:1px solid #d1d5db;
  border-radius:6px;
  overflow:hidden;
  background:#fff;
}

.progTable{
  width:100%;
  border-collapse:collapse;
  font-size:10px;
}
.progTable th,
.progTable td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
}
.progTable th{
  background:#f9fafb;
  text-align:left;
}
.progTable td:last-child,
.progTable th:last-child{
  text-align:right;
}
</style>
</head>

<body>
<div id="container">

  <div class="titleBar">Canais 1P</div>

  <div id="loader"><div class="spinner"></div></div>

  <div class="wrap" id="wrap">
    <div class="topRow">
      <div class="chartBox">
        <svg id="donut" viewBox="0 0 100 100"></svg>
      </div>

      <div class="tableBox">
        <table class="progTable">
          <thead>
            <tr>
              <th>Canal</th>
              <th>Prog %</th>
            </tr>
          </thead>
          <tbody id="progBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const LAYER_URL =
 "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  canal:"id_canal_venda",
  codZ:"cod_loja_zinflu2",
  valorAtual:"valor_vendas_atual",
  valorAnterior:"valor_vendas_anterior"
};

function showLoader(on){
  document.getElementById("loader").style.display = on ? "flex" : "none";
}
function showUI(on){
  const w=document.getElementById("wrap");
  w.style.opacity=on?"1":"0";
  w.style.pointerEvents=on?"auto":"none";
}

async function esriQuery(params){
  const u=new URL(LAYER_URL+"/query");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  const j=await r.json();
  if(!r.ok||j.error) throw j.error;
  return j;
}

function fmtPct1(n){
  return Number(n||0).toFixed(1).replace(".",",")+"%";
}

async function load(){
  showLoader(true);

  const where = `1=1 AND ${FIELDS.codZ} IS NOT NULL AND ${FIELDS.codZ} <> '0'`;

  const q = await esriQuery({
    f:"json",
    where,
    groupByFieldsForStatistics: FIELDS.canal,
    outStatistics: JSON.stringify([
      { statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"A" },
      { statisticType:"sum", onStatisticField:FIELDS.valorAnterior, outStatisticFieldName:"B" }
    ]),
    returnGeometry:"false"
  });

  const rows = q.features.map(f=>{
    const a=+f.attributes.A||0;
    const b=+f.attributes.B||0;

    return {
      label:f.attributes[FIELDS.canal],
      prog: b ? ((a - b) / b) * 100 : 0
    };
  });

  const tb=document.getElementById("progBody");
  tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.label}</td><td>${fmtPct1(r.prog)}</td>`;
    tb.appendChild(tr);
  });

  showLoader(false);
  showUI(true);
}

load();
</script>
</body>
</html>
