<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  font-family:Arial,Helvetica,sans-serif;
}
#container{
  height:100%;
  display:flex;
  flex-direction:column;
}
.titleBar{
  background:#6FAFB3;
  color:#fff;
  text-align:center;
  padding:6px;
  font-weight:600;
}
.wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.topRow{
  display:flex;
  gap:20px;
  align-items:center;
}
.chartBox{
  width:240px;
  height:240px;
}
svg{ width:100%; height:100%; overflow:visible; }

.legend{
  display:flex;
  gap:14px;
  font-size:11px;
}
.legItem{
  display:flex;
  gap:6px;
  align-items:center;
}
.swatch{
  width:12px;
  height:12px;
  border-radius:3px;
}
.tableBox{
  border:1px solid #d1d5db;
  border-radius:6px;
  overflow:hidden;
}
table{
  border-collapse:collapse;
  font-size:11px;
}
th,td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
}
th{ background:#f9fafb; text-align:left; }
td:last-child, th:last-child{ text-align:right; }

.pctLabel{
  font-size:10px;
  font-weight:600;
  fill:#111827;
}
.line{
  stroke:#6b7280;
  stroke-width:0.6;
}
</style>
</head>

<body>
<div id="container">
  <div class="titleBar">Canais 1P</div>

  <div class="wrap">
    <div class="topRow">
      <div class="chartBox">
        <svg id="donut" viewBox="0 0 100 100"></svg>
      </div>

      <div class="tableBox">
        <table>
          <thead>
            <tr><th>Canal</th><th>Prog %</th></tr>
          </thead>
          <tbody id="progBody"></tbody>
        </table>
      </div>
    </div>

    <div class="legend" id="legend"></div>
  </div>
</div>

<script>
/* ================= CONFIG FILTROS ================= */

const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  codZ: "cod_loja_zinflu2",
  atual: "valor_vendas_atual",
  ant: "valor_vendas_anterior"
};

const CANAL_LABEL = {
  "0": "E-commerce",
  "1": "Loja FÃ­sica",
  "2": "Televendas"
};

const CANAL_COLOR = {
  "0": "#1F5A78",
  "1": "#0B2E3F",
  "2": "#F28C38"
};

const qs = new URLSearchParams(window.location.search);

function escapeSqlString(s){
  return String(s).replace(/'/g,"''");
}
function parseList(name){
  if(!qs.has(name)) return [];
  return qs.get(name).split(",").map(v=>v.trim()).filter(Boolean);
}
function buildWhere(){
  const parts = ["1=1", `${FIELDS.codZ} IS NOT NULL`, `${FIELDS.codZ} <> '0'`];

  const filtros = {
    loja: FIELDS.loja,
    mes: FIELDS.mes,
    ano: FIELDS.ano,
    id_canal_venda: FIELDS.canal,
    secao: FIELDS.secao
  };

  for(const k in filtros){
    const vals = parseList(k);
    if(vals.length){
      parts.push(`${filtros[k]} IN (${vals.map(v=>`'${escapeSqlString(v)}'`).join(",")})`);
    }
  }
  return parts.join(" AND ");
}
async function esriQuery(params){
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url);
  const j = await r.json();
  if(j.error) throw j.error;
  return j;
}

/* ================= LOAD DADOS ================= */

async function load(){
  const where = buildWhere();

  const q = await esriQuery({
    f:"json",
    where,
    groupByFieldsForStatistics: FIELDS.canal,
    outStatistics: JSON.stringify([
      { statisticType:"sum", onStatisticField:FIELDS.atual, outStatisticFieldName:"ATUAL" },
      { statisticType:"sum", onStatisticField:FIELDS.ant,   outStatisticFieldName:"ANT" }
    ]),
    returnGeometry:"false"
  });

  const data = q.features.map(f=>{
    const canal = String(f.attributes[FIELDS.canal]);
    return {
      label: CANAL_LABEL[canal],
      atual: Number(f.attributes.ATUAL||0),
      ant:   Number(f.attributes.ANT||0),
      color: CANAL_COLOR[canal]
    };
  }).filter(d=>d.atual>0);

  render(data);
}

/* ================= RENDER BASELINE (INALTERADO) ================= */

function render(data){
  const svg = document.getElementById("donut");
  svg.innerHTML="";
  document.getElementById("legend").innerHTML="";
  document.getElementById("progBody").innerHTML="";

  const cx=50, cy=50, rO=42, rI=26;
  const total = data.reduce((s,d)=>s+d.atual,0);

  const bg = document.createElementNS("http://www.w3.org/2000/svg","circle");
  bg.setAttribute("cx",cx);
  bg.setAttribute("cy",cy);
  bg.setAttribute("r",(rO+rI)/2);
  bg.setAttribute("fill","none");
  bg.setAttribute("stroke","#e5e7eb");
  bg.setAttribute("stroke-width",rO-rI);
  svg.appendChild(bg);

  let angle=-90;

  data.forEach(d=>{
    const pct=d.atual/total;
    const delta=pct*360;

    const a0=angle*Math.PI/180;
    const a1=(angle+delta)*Math.PI/180;

    const path=document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("fill",d.color);
    path.setAttribute("d",`
      M ${cx+rO*Math.cos(a1)} ${cy+rO*Math.sin(a1)}
      A ${rO} ${rO} 0 ${delta>180?1:0} 0 ${cx+rO*Math.cos(a0)} ${cy+rO*Math.sin(a0)}
      L ${cx+rI*Math.cos(a0)} ${cy+rI*Math.sin(a0)}
      A ${rI} ${rI} 0 ${delta>180?1:0} 1 ${cx+rI*Math.cos(a1)} ${cy+rI*Math.sin(a1)}
      Z`);
    svg.appendChild(path);

    const mid=angle+delta/2;
    const rad=mid*Math.PI/180;
    const x1=cx+rO*Math.cos(rad), y1=cy+rO*Math.sin(rad);
    const x2=cx+(rO+8)*Math.cos(rad), y2=cy+(rO+8)*Math.sin(rad);
    const x3=x2+(Math.cos(rad)>0?6:-6);

    const line=document.createElementNS("http://www.w3.org/2000/svg","polyline");
    line.setAttribute("points",`${x1},${y1} ${x2},${y2} ${x3},${y2}`);
    line.setAttribute("class","line");
    line.setAttribute("fill","none");
    svg.appendChild(line);

    const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
    txt.setAttribute("x",x3+(Math.cos(rad)>0?2:-2));
    txt.setAttribute("y",y2);
    txt.setAttribute("text-anchor",Math.cos(rad)>0?"start":"end");
    txt.setAttribute("dominant-baseline","middle");
    txt.setAttribute("class","pctLabel");
    txt.textContent=(pct*100).toFixed(1).replace(".",",")+"%";
    svg.appendChild(txt);

    angle+=delta;

    document.getElementById("legend").innerHTML+=`
      <div class="legItem">
        <span class="swatch" style="background:${d.color}"></span>
        <span>${d.label}</span>
      </div>`;

    const prog=((d.atual-d.ant)/d.ant)*100;
    document.getElementById("progBody").innerHTML+=`
      <tr><td>${d.label}</td><td>${prog.toFixed(2).replace(".",",")}%</td></tr>`;
  });
}

load();
</script>
</body>
</html>
