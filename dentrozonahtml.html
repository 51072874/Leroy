<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:transparent;
  overflow:hidden;
  font-family: Arial, Helvetica, sans-serif;
  color:#444444;
}
#container{
  position:relative;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.spinner{
  width:22px;
  height:22px;
  border:3px solid #ddd;
  border-top-color:#2b7cff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
.loading #content{ visibility:hidden; }
#content{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.kpiWrap{
  width:100%;
  max-width:520px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  overflow:hidden;
  border-radius:6px;
}
.kpi{
  background:#e3e3e3;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
}
.kpi + .kpi{ border-left:1px solid #fff; }
.kpiValue{
  font-size:11px;
  font-weight:600;
  display:flex;
  gap:4px;
}
</style>
</head>

<body class="loading">
<div id="container">
  <div id="loader"><div class="spinner"></div></div>

  <div id="content">
    <div class="kpiWrap">
      <div class="kpi"><div class="kpiValue"><span>R$</span><span id="vAtual">â€”</span></div></div>
      <div class="kpi"><div class="kpiValue"><span id="vPct">â€”</span><span>%</span></div></div>
      <div class="kpi"><div class="kpiValue"><span id="vProg">â€”</span><span>%</span></div></div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const LAYER_URL =
 "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja:"id_loja_venda",
  mes:"mes",
  ano:"ano",
  canal:"id_canal_venda",
  secao:"secao",
  codZ:"cod_loja_zinflu2",
  valorAtual:"valor_vendas_atual",
  valorAnterior:"valor_vendas_anterior"
};

/* ================= FILTROS (WIDGET) ================= */
let currentSQLWhere = null;

window.addEventListener('message', function(event) {
  if (event.data.type === 'SPOTX_FILTER_CHANGE' && event.data.filters?.sqlWhere) {
    currentSQLWhere = event.data.filters.sqlWhere;
    load();
  }
});

/* ================= UTIL ================= */
function showLoader(on){
  document.getElementById("loader").style.display = on ? "flex":"none";
  document.body.classList.toggle("loading", on);
}
function fmtBR(n){
  return Number(n||0).toLocaleString("pt-BR",{minimumFractionDigits:2});
}
function fmtPct(n){
  return Number(n||0).toFixed(2).replace(".",",");
}

/* ================= WHERE BASE ================= */
function buildWhereBase(removeMes=false){
  let sql = currentSQLWhere && currentSQLWhere !== "1=1"
    ? currentSQLWhere
    : "1=1";

  if(removeMes){
    sql = sql.replace(/\s*AND\s+mes\s+IN\s*\([^)]+\)/gi,'')
             .replace(/\s*AND\s+mes\s*=\s*'[^']+'/gi,'');
  }
  return sql;
}

/* ================= WHERES ================= */
// ðŸ”¹ Selecionado (DENTRO da zona)
function whereSelecionado(){
  return `${buildWhereBase(false)} AND ${FIELDS.codZ} <> '0'`;
}

// ðŸ”¹ Total dentro
function whereTotalDentro(){
  return `${buildWhereBase(true)} AND ${FIELDS.codZ} <> '0'`;
}

// ðŸ”¹ Total fora
function whereTotalFora(){
  return `${buildWhereBase(true)} AND ${FIELDS.codZ} = '0'`;
}

/* ================= QUERY ================= */
async function esriQuery(params){
  const u=new URL(LAYER_URL+"/query");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  const j=await r.json();
  if(j.error) throw j.error;
  return j;
}

/* ================= LOAD ================= */
async function load(){
  showLoader(true);
  try{
    const sel = await esriQuery({
      f:"json",
      where:whereSelecionado(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"A"},
        {statisticType:"sum",onStatisticField:FIELDS.valorAnterior,outStatisticFieldName:"B"}
      ]),
      returnGeometry:false
    });

    const dentro = await esriQuery({
      f:"json",
      where:whereTotalDentro(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"TD"}
      ]),
      returnGeometry:false
    });

    const fora = await esriQuery({
      f:"json",
      where:whereTotalFora(),
      outStatistics:JSON.stringify([
        {statisticType:"sum",onStatisticField:FIELDS.valorAtual,outStatisticFieldName:"TF"}
      ]),
      returnGeometry:false
    });

    const A  = +sel.features?.[0]?.attributes?.A  || 0;
    const B  = +sel.features?.[0]?.attributes?.B  || 0;
    const TD = +dentro.features?.[0]?.attributes?.TD || 0;
    const TF = +fora.features?.[0]?.attributes?.TF || 0;

    const T = TD + TF;

    document.getElementById("vAtual").textContent = fmtBR(A);
    document.getElementById("vPct").textContent   = fmtPct(T ? (A/T)*100 : 0);
    document.getElementById("vProg").textContent  = fmtPct(B ? ((A-B)/B)*100 : 0);

  }catch(e){
    console.error(e);
    document.getElementById("vAtual").textContent="Erro";
    document.getElementById("vPct").textContent="â€”";
    document.getElementById("vProg").textContent="â€”";
  }
  showLoader(false);
}

load();
</script>
</body>
</html>
