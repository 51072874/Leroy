<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GrÃ¡fico SpotX</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui;
}
#wrap {
  position: relative;
  width: 100%;
  height: 100%;
}
#loader {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  z-index: 10;
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>

<body>
<div id="wrap">
  <div id="loader">Carregando...</div>
  <canvas id="chart"></canvas>
</div>

<script>
// ======================================================
// CONFIG
// ======================================================
const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

// Estado atual dos filtros
let FILTERS = {
  loja: [],
  mes: [],
  ano: [],
  secao: [],
  id_canal_venda: []
};

// ======================================================
// HELPERS
// ======================================================
const toArray = v =>
  !v ? [] : Array.isArray(v) ? v.map(String) : String(v).split(",").map(s => s.trim()).filter(Boolean);

function buildWhere() {
  const w = ["1=1"];

  if (FILTERS.loja.length)
    w.push(`id_loja_venda IN (${FILTERS.loja.map(v => `'${v}'`).join(",")})`);

  if (FILTERS.mes.length)
    w.push(`mes IN (${FILTERS.mes.map(v => `'${v}'`).join(",")})`);

  if (FILTERS.ano.length)
    w.push(`ano IN (${FILTERS.ano.map(v => `'${v}'`).join(",")})`);

  if (FILTERS.secao.length)
    w.push(`secao IN (${FILTERS.secao.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);

  if (FILTERS.id_canal_venda.length)
    w.push(`id_canal_venda IN (${FILTERS.id_canal_venda.map(v => `'${v}'`).join(",")})`);

  console.log("ðŸ§© WHERE:", w.join(" AND "));
  return w.join(" AND ");
}

async function query(params) {
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  console.log("ðŸŒ QUERY:", url.toString());
  const res = await fetch(url);
  return res.json();
}

// ======================================================
// CHART
// ======================================================
const chart = new Chart(document.getElementById("chart"), {
  type: "bar",
  data: {
    datasets: [{
      data: [],
      backgroundColor: "#1976d2",
      barThickness: 28
    }]
  },
  options: {
    indexAxis: "y",
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { beginAtZero: true },
      y: { ticks: { autoSkip: false } }
    },
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  }
});

// ======================================================
// LOAD (ÃšNICO PONTO DE CARGA)
// ======================================================
async function load() {
  const loader = document.getElementById("loader");
  loader.style.display = "flex";

  try {
    const where = buildWhere();

    const res = await query({
      f: "json",
      where,
      outFields: "classe_social",
      groupByFieldsForStatistics: "classe_social",
      outStatistics: JSON.stringify([
        {
          statisticType: "sum",
          onStatisticField: "valor_vendas_atual",
          outStatisticFieldName: "VAL"
        }
      ]),
      returnGeometry: "false"
    });

    const rows = (res.features || [])
      .map(f => ({
        y: f.attributes.classe_social,
        x: Number(f.attributes.VAL || 0)
      }))
      .filter(r => r.y && r.x > 0);

    console.log("ðŸ“Š Dados do grÃ¡fico:", rows);

    chart.data.datasets[0].data = rows;
    chart.update();

  } catch (err) {
    console.error("âŒ Erro ao carregar grÃ¡fico:", err);
    chart.data.datasets[0].data = [];
    chart.update();
  } finally {
    loader.style.display = "none";
  }
}

// ======================================================
// LISTENER DE FILTROS (SEU WIDGET)
// ======================================================
window.addEventListener("message", (event) => {
  if (!event.data) return;
  if (event.data.type !== "SPOTX_FILTER_CHANGE") return;

  console.log("ðŸ“¥ FILTROS RECEBIDOS:", event.data.filters);

  const f = event.data.filters || {};

  FILTERS = {
    loja: toArray(f.cod_loja),
    mes: toArray(f.mes),
    ano: toArray(f.ano),
    secao: toArray(f.secao),
    id_canal_venda: toArray(f.id_canal_venda)
  };

  load();
});

// ======================================================
// CARGA INICIAL (SEM FILTRO)
// ======================================================
console.log("ðŸŸ¢ GrÃ¡fico iniciado â€“ carga inicial");
load();
</script>
</body>
</html>
