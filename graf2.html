<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gr√°fico SpotX - Vendas por Classe Social</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: #fff;
}
#container { position: relative; height: 100%; width: 100%; }
#loader {
  position: absolute; inset: 0;
  display: none;
  align-items: center; justify-content: center;
  background: rgba(255,255,255,0.9); z-index: 10;
}
.spinner {
  width: 40px; height: 40px;
  border: 4px solid #ddd;
  border-top-color: #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
#nodata {
  display: none;
  position: absolute; inset: 0;
  align-items: center; justify-content: center;
  color: #666; font-size: 14px;
}
canvas { width: 100% !important; height: 100% !important; }
</style>
</head>

<body>
<div id="container">
  <div id="loader"><div class="spinner"></div></div>
  <div id="nodata">Nenhum dado para os filtros selecionados</div>
  <canvas id="chart"></canvas>
</div>

<script>
// =====================================================
// CONFIG
// =====================================================
const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const CLASS_COLORS = {
  "A1": "#0B2C3D",
  "A2": "#1F4E66",
  "B1": "#2E6B3F",
  "B2": "#6FAF8E",
  "C1": "#F2D36B",
  "C2": "#F6E8B1",
  "D/E": "#D9D9D9"
};

const collator = new Intl.Collator("pt-BR", { numeric: true });

let FILTERS = {
  loja: [], mes: [], ano: [], secao: [], id_canal_venda: []
};

let IS_LOADING = false;
let LAST_FILTER_HASH = null;

// =====================================================
// HELPERS
// =====================================================
const toArray = v =>
  !v ? [] : Array.isArray(v) ? v.map(String) : String(v).split(",").filter(Boolean);

function hashFilters(f) {
  return JSON.stringify({
    loja: [...f.loja].sort(),
    mes: [...f.mes].sort(),
    ano: [...f.ano].sort(),
    secao: [...f.secao].sort(),
    id_canal_venda: [...f.id_canal_venda].sort()
  });
}

function buildWhere() {
  const p = ["1=1"];

  if (FILTERS.loja.length)
    p.push(`id_loja_venda IN (${FILTERS.loja.map(v => `'${v}'`).join(",")})`);
  if (FILTERS.mes.length)
    p.push(`mes IN (${FILTERS.mes.map(v => `'${v}'`).join(",")})`);
  if (FILTERS.ano.length)
    p.push(`ano IN (${FILTERS.ano.map(v => `'${v}'`).join(",")})`);
  if (FILTERS.secao.length)
    p.push(`secao IN (${FILTERS.secao.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);
  if (FILTERS.id_canal_venda.length)
    p.push(`id_canal_venda IN (${FILTERS.id_canal_venda.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);

  console.log("üß© WHERE FINAL:", p.join(" AND "));
  return p.join(" AND ");
}

async function esriQuery(params) {
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  console.log("üåê URL:", url.toString());

  const res = await fetch(url);
  const json = await res.json();
  if (!res.ok || json.error) throw json.error || new Error("Erro ESRI");
  return json;
}

// =====================================================
// CHART
// =====================================================
const chart = new Chart(document.getElementById("chart"), {
  type: "bar",
  data: { datasets: [{ data: [], backgroundColor: [], barThickness: 28 }] },
  options: {
    indexAxis: "y",
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 600 },
    scales: {
      x: { beginAtZero: true, ticks: { callback: v => v + "%" } },
      y: { ticks: { autoSkip: false, font: { weight: "bold" } } }
    },
    plugins: { legend: { display: false }, tooltip: { enabled: false } }
  }
});

// =====================================================
// LOAD DATA (ANTI-LOOP)
// =====================================================
async function load() {
  if (IS_LOADING) {
    console.warn("‚è≥ Load ignorado (j√° carregando)");
    return;
  }

  IS_LOADING = true;
  document.getElementById("loader").style.display = "flex";
  document.getElementById("nodata").style.display = "none";

  try {
    const where = buildWhere();

    const byClass = await esriQuery({
      f: "json",
      where,
      outFields: "classe_social",
      groupByFieldsForStatistics: "classe_social",
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: "valor_vendas_atual", outStatisticFieldName: "SUM_V" }
      ]),
      returnGeometry: "false"
    });

    const totalQ = await esriQuery({
      f: "json",
      where,
      outStatistics: JSON.stringify([
        { statisticType: "sum", onStatisticField: "valor_vendas_atual", outStatisticFieldName: "TOTAL" }
      ]),
      returnGeometry: "false"
    });

    const total = totalQ.features?.[0]?.attributes?.TOTAL || 0;

    const rows = (byClass.features || [])
      .map(f => ({
        y: f.attributes.classe_social,
        x: total ? (f.attributes.SUM_V / total) * 100 : 0
      }))
      .filter(r => r.y);

    rows.sort((a,b) => collator.compare(a.y, b.y));

    if (!rows.length || total === 0) {
      document.getElementById("nodata").style.display = "flex";
      chart.data.datasets[0].data = [];
    } else {
      chart.data.datasets[0].data = rows;
      chart.data.datasets[0].backgroundColor =
        rows.map(r => CLASS_COLORS[r.y] || "#999");
    }

    chart.update();
  } catch (e) {
    console.error("‚ùå Erro no gr√°fico:", e);
    document.getElementById("nodata").style.display = "flex";
  } finally {
    IS_LOADING = false;
    document.getElementById("loader").style.display = "none";
  }
}

// =====================================================
// MESSAGE LISTENER (FINAL)
// =====================================================
window.addEventListener("message", (event) => {
  if (!event.data) return;

  if (
    event.data.type !== "SPOTX_FILTER_CHANGE" &&
    event.data.type !== "EXB_SET_FILTER"
  ) return;

  const raw = event.data.filters || event.data.payload?.filters;
  if (!raw) return;

  const nextFilters = {
    loja: toArray(raw.cod_loja),
    mes: toArray(raw.mes),
    ano: toArray(raw.ano),
    secao: toArray(raw.secao),
    id_canal_venda: toArray(raw.id_canal_venda)
  };

  const hash = hashFilters(nextFilters);
  if (hash === LAST_FILTER_HASH) {
    console.warn("üîÅ Filtro repetido ‚Äî ignorado");
    return;
  }

  LAST_FILTER_HASH = hash;
  FILTERS = nextFilters;

  console.log("‚úÖ Filtros aplicados:", FILTERS);
  load();
});

console.log("üß† SpotX Gr√°fico pronto e aguardando filtros");
</script>
</body>
</html>
