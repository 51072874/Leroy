<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Filtros SpotX - Experience Builder</title>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    #filterCard {
      position: relative;
      margin: 12px;
      width: 360px;
    }

    .card {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }

    .card h3 { margin: 0 0 8px 0; font-size: 16px; }
    label { display: block; margin-top: 10px; font-weight: 700; font-size: 13px; }

    select, .dropdown-btn {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .dropdown { position: relative; }

    .dropdown-panel {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px;
      max-height: 260px;
      overflow-y: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      z-index: 9999;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
    }

    .item:hover { background: #f1f7ff; }

    .controls {
      display:flex;
      gap:6px;
      margin-bottom:8px;
    }

    .controls button {
      flex:1;
      padding:8px;
      border-radius:6px;
      border:1px solid #e0e0e0;
      background:#fafafa;
      cursor:pointer;
      font-size:12px;
    }

    .footer {
      display:flex;
      gap:8px;
      margin-top:12px;
    }

    .btn-primary {
      flex:1;
      padding:10px;
      border-radius:8px;
      background:#1976d2;
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:700;
    }

    .btn-clear {
      flex:1;
      padding:10px;
      border-radius:8px;
      background:#fff;
      border:1px solid #e0e0e0;
      cursor:pointer;
    }
  </style>
</head>

<body>

<div id="filterCard" class="card">
  <h3>Filtros Avançados</h3>

  <label for="selLoja">Loja</label>
  <select id="selLoja"></select>

  <label>Seção</label>
  <div class="dropdown">
    <div class="dropdown-btn" onclick="openPanel(event,'panelSecao')">
      <span id="lblSecao">Selecionar...</span> <span id="cntSecao">0</span>
    </div>
    <div class="dropdown-panel" id="panelSecao">
      <div class="controls">
        <button onclick="selectAll('secao')">Selecionar tudo</button>
        <button onclick="clearAll('secao')">Limpar</button>
      </div>
      <div id="listSecao"></div>
    </div>
  </div>

  <label>Canal</label>
  <div class="dropdown">
    <div class="dropdown-btn" onclick="openPanel(event,'panelCanal')">
      <span id="lblCanal">Selecionar...</span> <span id="cntCanal">0</span>
    </div>
    <div class="dropdown-panel" id="panelCanal">
      <div class="controls">
        <button onclick="selectAll('canal')">Selecionar tudo</button>
        <button onclick="clearAll('canal')">Limpar</button>
      </div>
      <div id="listCanal"></div>
    </div>
  </div>

  <label for="selAno">Ano</label>
  <select id="selAno"></select>

  <label>Mês</label>
  <div class="dropdown">
    <div class="dropdown-btn" onclick="openPanel(event,'panelMes')">
      <span id="lblMes">Selecionar...</span> <span id="cntMes">0</span>
    </div>
    <div class="dropdown-panel" id="panelMes">
      <div class="controls">
        <button onclick="selectAll('mes')">Selecionar tudo</button>
        <button onclick="clearAll('mes')">Limpar</button>
      </div>
      <div id="listMes"></div>
    </div>
  </div>

  <div class="footer">
    <button class="btn-primary" onclick="aplicar()">Aplicar</button>
    <button class="btn-clear" onclick="limpar()">Limpar</button>
  </div>
</div>

<script>
const VENDAS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";
const LOJAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";

let dataset = [];
let state = { loja: "", secao: [], canal: [], ano: "", mes: [] };

async function init() {
  const params = new URLSearchParams(window.location.search);
  state.loja  = params.get("cod_loja") || "";
  state.secao = (params.get("secao") || "").split(",").filter(Boolean);
  state.canal = (params.get("id_canal_venda") || "").split(",").filter(Boolean);
  state.ano   = params.get("ano") || "";
  state.mes   = (params.get("mes") || "").split(",").filter(Boolean);

  const lojas = await fetch(`${LOJAS_URL}/query?where=1=1&outFields=cod_loja,nome_loja&f=json`).then(r=>r.json());
  const sel = document.getElementById("selLoja");
  sel.innerHTML = `<option value="">-- Todas --</option>`;
  lojas.features.forEach(f=>{
    sel.innerHTML += `<option value="${f.attributes.cod_loja}">${f.attributes.cod_loja} - ${f.attributes.nome_loja}</option>`;
  });
  sel.value = state.loja;
  sel.onchange = () => { state.loja = sel.value; atualizarFiltros(); };

  const vendas = await fetch(`${VENDAS_URL}/query?where=1=1&outFields=secao,id_canal_venda,ano,mes,id_loja_venda&f=json`).then(r=>r.json());
  dataset = vendas.features.map(f=>f.attributes);

  atualizarFiltros();
}
init();

function atualizarFiltros() {
  let filtrado = dataset.filter(r => {
    if (state.loja && r.id_loja_venda != state.loja) return false;
    if (state.ano && r.ano != state.ano) return false;
    return true;
  });

  renderDomain("secao", [...new Set(filtrado.map(r => r.secao))].filter(Boolean));
  renderDomain("canal", [...new Set(filtrado.map(r => r.id_canal_venda))].filter(Boolean));
  renderDomain("mes", ["1","2","3","4","5","6","7","8","9","10","11","12"]);

  const anos = [...new Set(filtrado.map(r => r.ano))].filter(Boolean);
  const selAno = document.getElementById("selAno");
  selAno.innerHTML = `<option value="">-- Todos --</option>` + anos.map(a=>`<option value="${a}">${a}</option>`).join("");
  selAno.value = state.ano;
  selAno.onchange = ()=>{ state.ano = selAno.value; };
}

function renderDomain(field, values) {
  const list = document.getElementById("list"+field.charAt(0).toUpperCase()+field.slice(1));
  list.innerHTML = "";
  values.forEach(v=>{
    list.innerHTML += `<label class="item"><input type="checkbox" value="${v}" onchange="toggleValue('${field}',this.checked,this.value)" ${state[field].includes(v)?'checked':''}> ${v}</label>`;
  });
  atualizarLabels();
}

function toggleValue(field, checked, value) {
  if (checked) state[field].push(value);
  else state[field] = state[field].filter(v=>v!==value);
}

function selectAll(field) {
  document.querySelectorAll(`#list${field.charAt(0).toUpperCase()+field.slice(1)} input`).forEach(i=>i.checked=true);
}

function clearAll(field) { state[field]=[]; atualizarFiltros(); }

function atualizarLabels() {
  cntSecao.textContent = state.secao.length;
  lblSecao.textContent = state.secao.length ? `${state.secao.length} selecionados` : "Selecionar...";
  cntCanal.textContent = state.canal.length;
  lblCanal.textContent = state.canal.length ? `${state.canal.length} selecionados` : "Selecionar...";
  cntMes.textContent = state.mes.length;
  lblMes.textContent = state.mes.length ? `${state.mes.length} selecionados` : "Selecionar...";
}

function aplicar() {
  const p = new URLSearchParams();
  if (state.loja) p.set("cod_loja", state.loja);
  if (state.secao.length) p.set("secao", state.secao.join(","));
  if (state.canal.length) p.set("id_canal_venda", state.canal.join(","));
  if (state.ano) p.set("ano", state.ano);
  if (state.mes.length) p.set("mes", state.mes.join(","));
  window.parent.location.href = window.location.origin + window.location.pathname + "?" + p.toString();
}

function limpar() {
  state = { loja:"", secao:[], canal:[], ano:"", mes:[] };
  aplicar();
}

function openPanel(e,id){
  e.stopPropagation();
  document.querySelectorAll(".dropdown-panel").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

document.addEventListener("click",()=>document.querySelectorAll(".dropdown-panel").forEach(p=>p.style.display="none"));
</script>

</body>
</html>
