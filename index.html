<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Mapa Leroy Merlin</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.30/"></script>

<style>
html, body, #viewDiv {
  padding:0; margin:0; height:100%; width:100%;
}
</style>
</head>

<body>
<div id="viewDiv"></div>

<script>
/******************* PARAMS *************************/
const params = new URLSearchParams(location.search);
const codLoja = params.get("cod_loja") || "";
if(!codLoja) alert("Parâmetro ?cod_loja não informado!");

/******************* URLs ***************************/
const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

/******************* MAPA ***************************/
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function(Map,MapView,FeatureLayer){

  let center = [-46.63,-23.55];
  let zoom   = 11;

  if(codLoja==="0"){
    center=[-55,-15];
    zoom=4;
  }

  const map = new Map({ basemap:"streets-navigation-vector" });

  const view = new MapView({
      container:"viewDiv",
      map,
      center,
      zoom
  });

  /*------------------- Layers --------------------*/
  const bairrosLayer = new FeatureLayer({
     url:BAIRROS_URL,
     outFields:["*"],
     labelingInfo:[{
       labelExpressionInfo:{ expression:"$feature.nome_bairr" },
       minScale:0,
       symbol:{ type:"text", color:"#333", haloColor:"#fff", haloSize:1 }
     }]
  });

  const zonasLayer = new FeatureLayer({
     url:ZONAS_URL,
     outFields:["*"]
  });

  const lojasLayer = new FeatureLayer({
     url:LOJAS_URL,
     outFields:["*"]
  });

  map.addMany([bairrosLayer, zonasLayer, lojasLayer]);

  /*************** VIEW READY *************************/
  view.when(async()=>{

    /*************** MODO BRASIL ***********************/
    if(codLoja==="0"){
      lojasLayer.visible=true;
      zonasLayer.visible=false;
      bairrosLayer.visible=false;
      try{
        lojasLayer.definitionExpression="1=1";
      }catch(e){}
      await view.goTo({center:[-55,-15], zoom:4}).catch(()=>{});
      return;
    }

    /**************** MODO POR LOJA ********************/
    bairrosLayer.definitionExpression=`cod_loja_zinflu='${codLoja}'`;
    zonasLayer.definitionExpression  =`COD_LOJA='${codLoja}'`;
    lojasLayer.definitionExpression  =`cod_loja='${codLoja}'`;

    const q = bairrosLayer.createQuery();
    q.where=`cod_loja_zinflu='${codLoja}'`;
    q.returnGeometry=true;
    q.outFields=["cod_bairro"];

    const r = await bairrosLayer.queryFeatures(q);
    if(!r.features.length) return;

    await view.goTo(r.features.map(f=>f.geometry.extent)).catch(()=>{});

    const lista = r.features.map(f=> `'${f.attributes.cod_bairro}'`).join(",");

    /******** vendas ************/
    const vendasLayer = new FeatureLayer({ url:VENDAS_URL });

    const qv=vendasLayer.createQuery();
    qv.where=`id_bairro_cep IN (${lista})`;
    qv.outFields=["id_bairro_cep","valor_vendas_atual","valor_vendas_anterior"];

    const vendas = await vendasLayer.queryFeatures(qv);

    const progresso={};
    vendas.features.forEach(f=>{
      const a=f.attributes.valor_vendas_atual||0;
      const b=f.attributes.valor_vendas_anterior||0;
      let pct=0;
      if(b!==0) pct=((a/b)-1)*100;
      progresso[f.attributes.id_bairro_cep]=pct;
    });

    /******* renderer **********/
    bairrosLayer.renderer={
      type:"simple",
      symbol:{ type:"simple-fill", outline:{color:"#777",width:0.5} },
      visualVariables:[{
        type:"color",
        valueExpression:`
          var pg=${JSON.stringify(progresso)};
          var v=pg[$feature.cod_bairro];
          return DefaultValue(v,0);
        `,
        stops:[
          {value:-20,color:"rgba(192,0,0,0.3)"},
          {value:-10,color:"rgba(255,63,63,0.3)"},
          {value:0,color:"rgba(244,146,75,0.3)"},
          {value:10,color:"rgba(127,255,255,0.3)"},
          {value:20,color:"rgba(0,192,192,0.3)"},
          {value:100,color:"rgba(0,128,128,0.3)"}
        ]
      }]
    };

    bairrosLayer.refresh();
  });

});
</script>

</body>
</html>
