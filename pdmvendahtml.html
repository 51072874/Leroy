<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --text:#111827;
  --muted:#6b7280;
  --bar:#4F7987;
  --barHover:#3F6673;
  --axis:#e5e7eb;
}

html,body{
  margin:0;
  height:100%;
  background:transparent;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
}
*{ box-sizing:border-box; }

#container{
  height:100%;
  padding:10px;
  display:flex;
  flex-direction:column;
}

.title{
  flex:0 0 auto;
  text-align:center;
  font-weight:600;
  font-size:14px;
  line-height:1.2;
  margin:0 0 10px 0;
}

#content{
  position:relative;
  flex:1 1 auto;
  min-height:0;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  gap:4px;
}

#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
  pointer-events:none;
}
.spinner{
  width:36px;
  height:36px;
  border:4px solid #d1d5db;
  border-top-color:#2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.chart{
  flex:1 1 auto;
  min-height:0;
  display:flex;
  gap:8px;
}

.yAxis{
  width:46px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  padding-top:25px; 
  padding-bottom:44px;
}
.yTick{
  font-size:10px;
  color:var(--muted);
  transform:translateY(50%);
}

.plot{
  flex:1;
  position:relative;
  min-height:0;
}

.bars{
  position:absolute;
  inset:0;
  display:flex;
  align-items:flex-end;
  gap:clamp(10px, 2vw, 16px);
  padding:10px 14px 14px 14px;
}

.barCol{
  flex:1;
  min-width:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

.barValue{
  font-weight:400;
  font-variant-numeric: tabular-nums;
  font-size:11px;
  white-space:nowrap;
}

.bar{
  width:min(54px, 100%);
  background:var(--bar);
  border-radius:10px 10px 6px 6px;
  transition:.15s ease;
}
.bar:hover{ background:var(--barHover); transform:translateY(-1px); }

.barLabel{
  height:14px;
  line-height:14px;
  color:var(--muted);
  font-size:11px;
  width:100%;
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.prog{
  flex:0 0 auto;
  display:grid;
  gap:6px;
  font-size:12px;
}
.prog div{
  text-align:center;
  padding:4px 0;
  border-top:1px solid var(--axis);
  font-variant-numeric: tabular-nums;
}
.prog-title{
  text-align:left;
  padding-left:6px;
  font-weight:600;
  color:var(--muted);
}
</style>
</head>

<body>
<div id="container">
  <div class="title">PDM / PROG</div>

  <div id="content">
    <div id="loader"><div class="spinner"></div></div>

    <div class="chart" id="chart" style="display:none">
      <div class="yAxis" id="yAxis"></div>
      <div class="plot" id="plot">
        <div class="bars" id="bars"></div>
      </div>
    </div>

    <div class="prog" id="prog"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

const LAYER_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  isocrona: "descricao_regiao_isocrona",
  vendasAtual: "valor_vendas_atual",
  vendasAnterior: "valor_vendas_anterior",
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano"
};

const qs = new URLSearchParams(window.location.search);

/* ================= UTIL ================= */

function parseList(paramName){
  if (!qs.has(paramName)) return [];
  return String(qs.get(paramName) || "")
    .split(",")
    .map(v=>v.trim())
    .filter(v=>v !== "");
}

function escapeSqlString(s){
  return String(s).replace(/'/g,"''");
}

function isBlank(v){
  const s = String(v ?? "").trim().toLowerCase();
  return !s || s === "null" || s === "undefined";
}

function isocronaKey(label){
  const s = String(label ?? "").toLowerCase();
  if (s.includes("fora")) return Number.POSITIVE_INFINITY;
  const m = s.match(/-?\d+([.,]\d+)?/);
  return m ? Number(m[0].replace(",", ".")) : Number.POSITIVE_INFINITY;
}

async function esriQuery(layerUrl, params){
  const u = new URL(layerUrl.replace(/\/+$/,"") + "/query");
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k,v));
  const r = await fetch(u.toString());
  const j = await r.json();
  if (!r.ok || j.error) throw (j.error || {message:`HTTP ${r.status}`});
  return j;
}

function fmt1(n){
  return (isFinite(n) ? n : 0).toFixed(2).replace(".",",");
}

function fmt0(n){
  return String(Math.round(isFinite(n) ? n : 0)).replace(".",",");
}

function niceStep(target){
  if (target <= 0) return 1;
  const pow = Math.pow(10, Math.floor(Math.log10(target)));
  const n = target / pow;
  let s;
  if (n <= 1) s = 1;
  else if (n <= 2) s = 2;
  else if (n <= 5) s = 5;
  else s = 10;
  return s * pow;
}

function buildYAxis(axisMax, step){
  const y = document.getElementById("yAxis");
  y.innerHTML = "";
  for (let i=5;i>=0;i--){
    const val = step * i;
    y.innerHTML += `<div class="yTick">${fmt0(val)}%</div>`;
  }
}

function buildInClause(field, values){
  const isNumeric = values.every(v => !isNaN(v) && v.trim() !== '');
  
  if (isNumeric) {
    return `${field} IN (${values.join(",")})`;
  } else {
    const inList = values.map(v => `'${escapeSqlString(v)}'`).join(",");
    return `${field} IN (${inList})`;
  }
}

function buildWhere(){
  const parts = ["1=1"];
  
  const lojas = parseList("loja");
  if (lojas.length) parts.push(`${FIELDS.loja} IN (${lojas.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
  
  const anos = parseList("ano");
  if (anos.length) parts.push(`${FIELDS.ano} IN (${anos.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
  
  const meses = parseList("mes");
  if (meses.length) parts.push(`${FIELDS.mes} IN (${meses.map(v => `'${escapeSqlString(v)}'`).join(",")})`);
  
  return parts.join(" AND ");
}

/* ================= RENDER ================= */

let LAST_ROWS = [];

function renderBars(rows){
  LAST_ROWS = rows;

  const barsEl = document.getElementById("bars");
  const plotEl = document.getElementById("plot");
  const chart = document.getElementById("chart");

  barsEl.innerHTML = "";
  chart.style.display = "flex";

  if (!rows.length){
    const prog0 = document.getElementById("prog");
    prog0.style.gridTemplateColumns = "48px";
    prog0.innerHTML = `<div class="prog-title">PROG</div>`;
    return;
  }

  const rawMax = Math.max(...rows.map(r=>r.value));
  const target = (rawMax * 1.05) / 5;
  const step = niceStep(target);
  const axisMax = step * 5;
  buildYAxis(axisMax, step);

  const plotH = plotEl.clientHeight || 240;
  const headerSpace = 80;
  const labelSpace = 30;
  const usable = Math.max(60, plotH - headerSpace - labelSpace);
  const maxBarPx = Math.min(260, usable);

  rows.forEach(r=>{
    const col = document.createElement("div");
    col.className = "barCol";

    const v = document.createElement("div");
    v.className = "barValue";
    v.textContent = fmt1(r.value) + "%";

    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.height = (12 + (r.value / axisMax) * maxBarPx) + "px";

    const lab = document.createElement("div");
    lab.className = "barLabel";
    lab.textContent = r.label;

    col.appendChild(v);
    col.appendChild(bar);
    col.appendChild(lab);
    barsEl.appendChild(col);
  });
}

window.addEventListener("resize", () => {
  if (LAST_ROWS.length) renderBars(LAST_ROWS);
});

/* ================= LOAD ================= */

async function load(){
  document.getElementById("loader").style.display="flex";

  try{
    const where = buildWhere();
    //console.log("Filtro WHERE:", where);
    
    // BUSCAR PDM (vendas por isócrona)
    const pdmByIso = await esriQuery(LAYER_URL,{
      f:"json",
      where: where,
      groupByFieldsForStatistics: FIELDS.isocrona,
      outStatistics: JSON.stringify([
        {statisticType:"sum", onStatisticField: FIELDS.vendasAtual, outStatisticFieldName:"VENDA_ISO"}
      ]),
      outFields: FIELDS.isocrona,
      returnGeometry:false
    });
    
    // BUSCAR TOTAL DA LOJA
    const pdmTotal = await esriQuery(LAYER_URL,{
      f:"json",
      where: where,
      outStatistics: JSON.stringify([
        {statisticType:"sum", onStatisticField: FIELDS.vendasAtual, outStatisticFieldName:"TOTAL"}
      ]),
      returnGeometry:false
    });
    
    const totalLoja = pdmTotal.features?.[0]?.attributes?.TOTAL || 0;
    console.log("Total da loja:", totalLoja);
    
    // Mapear vendas por isócrona
    const isoVendas = new Map();
    let somaIsocronas = 0;
    
    (pdmByIso.features || []).forEach(f=>{
      const iso = f.attributes?.[FIELDS.isocrona];
      const venda = f.attributes?.VENDA_ISO;
      if (!isBlank(iso) && venda != null) {
        const valor = Number(venda);
        if (isFinite(valor) && valor > 0) {
          const label = String(iso).trim();
          isoVendas.set(label, valor);
          somaIsocronas += valor;
          console.log(`${label}: R$ ${valor.toFixed(2)}`);
        }
      }
    });
    
    // Calcular percentuais PDM
    const isoPercentuais = new Map();
    
    isoVendas.forEach((venda, label) => {
      if (totalLoja > 0) {
        const perc = (venda / totalLoja) * 100;
        isoPercentuais.set(label, perc);
        console.log(`${label}: ${perc.toFixed(2)}%`);
      }
    });
    
    // Calcular "Fora de Zona"
    const foraDeZonaVenda = totalLoja - somaIsocronas;
    if (foraDeZonaVenda > 0 && isFinite(foraDeZonaVenda) && totalLoja > 0) {
      const foraDeZonaPerc = (foraDeZonaVenda / totalLoja) * 100;
      isoPercentuais.set("Fora de Zona", foraDeZonaPerc);
      console.log(`Fora de Zona: ${foraDeZonaPerc.toFixed(2)}%`);
    }
    
    // Criar array de rows para o gráfico
    const rows = Array.from(isoPercentuais.entries())
      .map(([label, value]) => ({ label, value }))
      .sort((a,b)=>isocronaKey(a.label)-isocronaKey(b.label));

    renderBars(rows);
    
    // BUSCAR PROG (progressão)
    const prog = await esriQuery(LAYER_URL,{
      f:"json",
      where: where,
      groupByFieldsForStatistics: FIELDS.isocrona,
      outStatistics: JSON.stringify([
        {statisticType:"sum", onStatisticField: FIELDS.vendasAtual, outStatisticFieldName:"VA"},
        {statisticType:"sum", onStatisticField: FIELDS.vendasAnterior, outStatisticFieldName:"VB"}
      ]),
      outFields: FIELDS.isocrona,
      returnGeometry:false
    });


	const mapProg = new Map();
		(prog.features || []).forEach(f => {
			const a = f.attributes || {};
			const iso = a[FIELDS.isocrona];
			const VA = Number(a.VA);
			const VB = Number(a.VB);

			if (isBlank(iso) || !isFinite(VA) || !isFinite(VB) || VB === 0) {
			mapProg.set(String(iso).trim(), null);
			return;
		}

		// PROG correta: soma atual / soma anterior
		const progPerc = (VA / VB) * 100;
		mapProg.set(String(iso).trim(), progPerc);
	});



    const progEl = document.getElementById("prog");
    progEl.style.gridTemplateColumns = `48px repeat(${rows.length || 1}, 1fr)`;

    const cells = rows.map(r=>{
      const v = mapProg.get(r.label);
      return `<div>${(v == null) ? "" : (fmt1(v) + "%")}</div>`;
    });

    progEl.innerHTML = `<div class="prog-title">PROG</div>${cells.join("")}`;

  }catch(e){
    console.error("Erro:", e);
  }finally{
    document.getElementById("loader").style.display="none";
    document.getElementById("chart").style.display="flex";
  }
}

load();
</script>
</body>
</html>
