<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Filtros SpotX</title>

  <style>
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      width: 100%; 
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #filterCard {
      width: 100%;
      max-width: 420px;
      margin: 20px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.12);
    }

    .card h3 { 
      margin: 0 0 16px 0; 
      font-size: 18px;
      color: #333;
    }

    label { 
      display: block; 
      margin-top: 14px; 
      font-weight: 700; 
      font-size: 13px;
      color: #555;
    }

    select, .dropdown-btn {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:focus, .dropdown-btn:focus {
      outline: none;
      border-color: #1976d2;
    }

    .dropdown { 
      position: relative; 
    }

    .dropdown-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 42px;
      padding: 8px 10px;
    }

    .dropdown-btn-content {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #e3f2fd;
      color: #1976d2;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .tag-remove {
      cursor: pointer;
      font-weight: bold;
      color: #1976d2;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .tag-remove:hover {
      opacity: 1;
    }

    .placeholder {
      color: #999;
      font-size: 13px;
    }

    .dropdown-panel {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      padding: 8px;
      max-height: 260px;
      overflow-y: auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    .dropdown-panel.open {
      display: block;
    }

    .item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px; 
      cursor: pointer; 
      border-radius: 6px; 
      font-size: 13px;
      transition: background 0.2s;
    }

    .item:hover { 
      background: #f1f7ff; 
    }

    .item input[type="checkbox"] {
      cursor: pointer;
    }

    .controls { 
      display: flex; 
      gap: 6px; 
      margin-bottom: 8px; 
    }

    .controls button { 
      flex: 1; 
      padding: 8px; 
      border-radius: 6px; 
      border: 1px solid #e0e0e0; 
      background: #fafafa; 
      cursor: pointer; 
      font-size: 12px;
      transition: all 0.2s;
    }

    .controls button:hover {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1976d2;
    }

    .controls button:active {
      transform: scale(0.98);
    }

    .footer { 
      display: flex; 
      gap: 10px; 
      margin-top: 20px; 
    }

    .btn-primary { 
      flex: 1; 
      padding: 12px; 
      border-radius: 8px; 
      background: #1976d2; 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      font-weight: 700;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-clear { 
      flex: 1; 
      padding: 12px; 
      border-radius: 8px; 
      background: #fff; 
      border: 1px solid #e0e0e0; 
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-clear:hover {
      background: #f5f5f5;
      border-color: #ccc;
    }

    /* Scrollbar customizada */
    .dropdown-panel::-webkit-scrollbar {
      width: 8px;
    }

    .dropdown-panel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .dropdown-panel::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 10px;
    }

    .dropdown-panel::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
</head>
<body>

  <div id="filterCard" class="card" role="region" aria-label="Painel de filtros">
    <h3>Filtros Avançados</h3>

    <label for="selLoja">Loja</label>
    <select id="selLoja" aria-label="Seleção de loja"></select>

    <label>Seção</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelSecao')" tabindex="0">
        <div class="dropdown-btn-content" id="tagsSecao">
          <span class="placeholder">Selecionar...</span>
        </div>
      </div>
      <div class="dropdown-panel" id="panelSecao">
        <div class="controls">
          <button type="button" onclick="selectAll('secao')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('secao')">Limpar</button>
        </div>
        <div id="listSecao"></div>
      </div>
    </div>

    <label>Canal</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelCanal')" tabindex="0">
        <div class="dropdown-btn-content" id="tagsCanal">
          <span class="placeholder">Selecionar...</span>
        </div>
      </div>
      <div class="dropdown-panel" id="panelCanal">
        <div class="controls">
          <button type="button" onclick="selectAll('canal')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('canal')">Limpar</button>
        </div>
        <div id="listCanal"></div>
      </div>
    </div>

    <label for="selAno">Ano</label>
    <select id="selAno" aria-label="Seleção de ano"></select>

    <label>Mês</label>
    <div class="dropdown">
      <div class="dropdown-btn" onclick="openPanel(event,'panelMes')" tabindex="0">
        <div class="dropdown-btn-content" id="tagsMes">
          <span class="placeholder">Selecionar...</span>
        </div>
      </div>
      <div class="dropdown-panel" id="panelMes">
        <div class="controls">
          <button type="button" onclick="selectAll('mes')">Selecionar tudo</button>
          <button type="button" onclick="clearAll('mes')">Limpar</button>
        </div>
        <div id="listMes"></div>
      </div>
    </div>

    <div class="footer">
      <button class="btn-primary" onclick="aplicar()">Aplicar</button>
      <button class="btn-clear" onclick="limpar()">Limpar</button>
    </div>
  </div>

<script>
  const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
  const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

  let dataset = [];
  let state = { loja: "", secao: [], canal: [], ano: "", mes: [] };

  const sanitize = v => v ? String(v).replace(/'/g, "''") : null;
  const buildIn = (field, values) => {
    const arr = (values || []).filter(Boolean).map(v => `'${sanitize(v)}'`);
    if (!arr.length) return null;
    if (arr.length === 1) return `${field}=${arr[0]}`;
    return `${field} IN (${arr.join(",")})`;
  };

  // Carregar dados via fetch (sem ArcGIS API)
  async function carregarLojas() {
    try {
      const response = await fetch(`${LOJAS_URL}/query?where=1=1&outFields=cod_loja,nome_loja&returnGeometry=false&f=json`);
      const data = await response.json();
      
      const sel = document.getElementById("selLoja");
      sel.innerHTML = `<option value="">-- Todas --</option>`;
      
      data.features.forEach(f => {
        const attrs = f.attributes;
        sel.innerHTML += `<option value="${attrs.cod_loja}">${attrs.cod_loja} - ${attrs.nome_loja}</option>`;
      });

      const params = new URLSearchParams(window.location.search);
      const codLojaURL = params.get("cod_loja");
      if (codLojaURL) {
        state.loja = codLojaURL;
        sel.value = codLojaURL;
      }

      sel.onchange = () => {
        state.loja = sel.value;
        atualizarFiltros();
      };
    } catch (error) {
      console.error("Erro ao carregar lojas:", error);
    }
  }

  async function carregarVendas() {
    try {
      const response = await fetch(`${VENDAS_URL}/query?where=1=1&outFields=secao,id_canal_venda,ano,mes,id_loja_venda&returnGeometry=false&f=json`);
      const data = await response.json();
      
      dataset = data.features.map(f => f.attributes);

      const params = new URLSearchParams(window.location.search);
      if (params.get("secao")) state.secao = params.get("secao").split(",").filter(Boolean);
      if (params.get("id_canal_venda")) state.canal = params.get("id_canal_venda").split(",").filter(Boolean);
      if (params.get("ano")) state.ano = params.get("ano");
      if (params.get("mes")) state.mes = params.get("mes").split(",").filter(Boolean);

      atualizarFiltros();
    } catch (error) {
      console.error("Erro ao carregar vendas:", error);
    }
  }

  function atualizarFiltros() {
    if (!dataset || !dataset.length) return;

    // Não aplica filtros entre campos - mostra todos os valores disponíveis
    renderDomain("secao", [...new Set(dataset.map(r => r.secao))].filter(Boolean).sort());
    renderDomain("canal", [...new Set(dataset.map(r => r.id_canal_venda))].filter(Boolean).sort());
    renderDomain("mes", ["1","2","3","4","5","6","7","8","9","10","11","12"]);
    renderAnos([...new Set(dataset.map(r => r.ano))].filter(Boolean).sort());
  }

  function renderDomain(field, values) {
    const list = document.getElementById("list" + capitalize(field));
    const selected = state[field] || [];

    if (!list) return;
    list.innerHTML = "";

    values.forEach(v => {
      const checked = selected.includes(String(v)) ? "checked" : "";
      list.innerHTML += `
        <label class="item">
          <input type="checkbox" value="${v}" ${checked}
            onchange="toggleValue('${field}', this.value, this.checked)">
          ${v}
        </label>
      `;
    });

    renderTags(field);
  }

  function renderTags(field) {
    const container = document.getElementById("tags" + capitalize(field));
    const selected = state[field] || [];

    if (!container) return;
    
    if (selected.length === 0) {
      container.innerHTML = '<span class="placeholder">Selecionar...</span>';
    } else {
      container.innerHTML = selected.map(v => `
        <span class="tag">
          ${v}
          <span class="tag-remove" onclick="removeTag('${field}', '${v}')">×</span>
        </span>
      `).join('');
    }
  }

  function removeTag(field, value) {
    state[field] = state[field].filter(v => v !== value);
    
    const checkbox = document.querySelector(`#list${capitalize(field)} input[value="${value}"]`);
    if (checkbox) checkbox.checked = false;
    
    renderTags(field);
  }

  function renderAnos(values) {
    const selAno = document.getElementById("selAno");
    if (!selAno) return;
    selAno.innerHTML = `<option value="">-- Todos --</option>`;
    values.forEach(v => selAno.innerHTML += `<option value="${v}">${v}</option>`);
    selAno.value = state.ano || "";
    selAno.onchange = () => { state.ano = selAno.value; atualizarFiltros(); };
  }

  function toggleValue(field, value, checked) {
    value = String(value);
    if (checked) {
      if (!state[field].includes(value)) state[field].push(value);
    } else {
      state[field] = state[field].filter(v => v !== value);
    }
    renderTags(field);
  }

  function selectAll(field) {
    const list = document.querySelectorAll(`#list${capitalize(field)} input`);
    state[field] = [...list].map(i => i.value);
    list.forEach(i => i.checked = true);
    renderTags(field);
  }

  function clearAll(field) {
    state[field] = [];
    const list = document.querySelectorAll(`#list${capitalize(field)} input`);
    list.forEach(i => i.checked = false);
    renderTags(field);
  }

  function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

  function openPanel(event, id) {
    event.stopPropagation();
    
    document.querySelectorAll(".dropdown-panel").forEach(p => p.classList.remove("open"));
    
    const el = document.getElementById(id);
    if (el) el.classList.add("open");
  }

  document.addEventListener("click", () => {
    document.querySelectorAll(".dropdown-panel").forEach(p => p.classList.remove("open"));
  });

  document.querySelectorAll(".dropdown-panel").forEach(panel => {
    panel.addEventListener("click", (e) => e.stopPropagation());
  });

  function aplicar() {
    const payload = {
      cod_loja: state.loja || null,
      secao: state.secao.length ? state.secao : null,
      id_canal_venda: state.canal.length ? state.canal : null,
      ano: state.ano || null,
      mes: state.mes.length ? state.mes : null
    };

    console.log("FILTROS APLICADOS:", payload);

    window.parent.postMessage(
      { type: "EXB_SET_FILTER", filters: payload },
      "*"
    );
  }

  function limpar() {
    state = { loja: "", secao: [], canal: [], ano: "", mes: [] };
    document.getElementById("selLoja").value = "";
    document.getElementById("selAno").value = "";
    
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    renderTags("secao");
    renderTags("canal");
    renderTags("mes");
    
    atualizarFiltros();
  }

  window.addEventListener("message", (evt) => {
    const msg = evt.data || {};
    if (msg.type === "EXB_SET_FILTER") {
      const f = msg.filters || {};
      if ('cod_loja' in f) {
        state.loja = f.cod_loja || "";
        document.getElementById("selLoja").value = state.loja || "";
      }
      if ('secao' in f) state.secao = f.secao || [];
      if ('id_canal_venda' in f) state.canal = f.id_canal_venda || [];
      if ('ano' in f) state.ano = f.ano || "";
      if ('mes' in f) state.mes = f.mes || [];
      atualizarFiltros();
    }
  });

  // Inicialização
  carregarLojas();
  carregarVendas();
</script>
</body>
</html>
