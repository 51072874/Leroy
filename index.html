<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Progressão Loja</title>

  <!-- ESRI -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.30/"></script>

  <style>
    html,
    body,
    #viewDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id="viewDiv"></div>

  <script>

    // ----------------------------------------------
    // pega loja do parâmetro
    // ----------------------------------------------
    const url = new URLSearchParams(window.location.search);
    const lojaParam = url.get("cod_loja") ? Number(url.get("cod_loja")) : null;

    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function (Map, MapView, FeatureLayer) {

      // ----------------------------------------------
      // CAMADA DOS BAIRROS (ajustar conforme seu serviço)
      // ----------------------------------------------
      const bairrosLayer = new FeatureLayer({
        url: "URL_DA_CAMADA",
        outFields: ["*"]
      });

      // ----------------------------------------------
      // MAPA
      // ----------------------------------------------
      const map = new Map({
        basemap: "streets-night-vector",
        layers: [bairrosLayer]
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-46.6, -23.55],
        zoom: 11
      });

      // ----------------------------------------------
      // Renderizador Graduado
      // ----------------------------------------------
      const renderer = {
        type: "simple",
        visualVariables: [
          {
            type: "color",
            field: "prog_loja",
            stops: [
              { value: -50, color: "#d32f2f" },
              { value: 0, color: "#fff176" },
              { value: 20, color: "#81c784" },
              { value: 50, color: "#388e3c" }
            ]
          }
        ]
      };
      bairrosLayer.renderer = renderer;

      // ----------------------------------------------
      // FUNÇÃO PARA ZOOM POR LOJA
      // ----------------------------------------------
      async function zoomByStore(codigoLoja) {
        if (!codigoLoja) return;

        const q = bairrosLayer.createQuery();
        q.where = `cod_loja=${codigoLoja}`;
        q.returnGeometry = true;

        const result = await bairrosLayer.queryFeatures(q);

        if (!result.features.length) {
          console.log("Nenhum bairro encontrado!");
          return;
        }

        const geom = result.features[0].geometry;

        view.goTo(
          {
            target: geom.extent.expand(1.5)
          },
          {
            animate: false        // <-- CORREÇÃO!
          }
        );
      }

      // ----------------------------------------------
      // CHAMA ZOOM
      // ----------------------------------------------
      view.when(() => {
        zoomByStore(lojaParam);
      });

    });
  </script>

</body>
</html>
