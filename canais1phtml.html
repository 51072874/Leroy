<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Donut – Progresso por Canal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    font-family: Arial, Helvetica, sans-serif;
    margin:0;
    padding:12px;
    background:#fff;
  }

  .wrap{
    display:flex;
    gap:24px;
    align-items:flex-start;
  }

  svg{
    width:260px;
    height:260px;
  }

  .legend{
    font-size:13px;
  }

  table{
    border-collapse:collapse;
    font-size:13px;
    margin-top:12px;
    width:100%;
  }

  th, td{
    border-bottom:1px solid #ddd;
    padding:6px 4px;
    text-align:left;
  }

  th:last-child,
  td:last-child{
    text-align:right;
  }
</style>
</head>

<body>

<div class="wrap">
  <svg id="donut" viewBox="0 0 200 200"></svg>

  <div>
    <div id="legend" class="legend"></div>

    <table>
      <thead>
        <tr>
          <th>Canal</th>
          <th>Prog %</th>
        </tr>
      </thead>
      <tbody id="tbl"></tbody>
    </table>
  </div>
</div>

<script>
/* =======================
   CONFIGURAÇÕES FIXAS
======================= */

// cores semânticas por canal
const CANAL_COLOR = {
  "0": "#0055A4", // e-commerce
  "1": "#78BE20", // Loja Física
  "2": "#FFB81C"  // Televendas
};

// ordem fixa do donut / legenda
const CANAL_ORDER = ["0","1","2"];

// labels
const CANAL_LABEL = {
  "0": "e-commerce",
  "1": "Loja Física",
  "2": "Televendas"
};

/* =======================
   FORMATADORES
======================= */

function fmtPctChart(n){
  if (!isFinite(n)) n = 0;
  return n.toFixed(1).replace(".", ",") + "%";
}

function fmtPctTable(n){
  if (!isFinite(n)) n = 0;
  return n.toFixed(2).replace(".", ",") + "%";
}

/* =======================
   DADOS (exemplo)
   Aqui entra seu fetch /
   query ArcGIS normalmente
======================= */

const rawData = [
  { canal:"0", pct: 0.04 },
  { canal:"1", pct: 1.79 },
  { canal:"2", pct:-7.19 }
];

/* =======================
   NORMALIZA + ORDEM FIXA
======================= */

const slices = rawData
  .map(d=>({
    canal:d.canal,
    label:CANAL_LABEL[d.canal],
    pct:d.pct,
    color:CANAL_COLOR[d.canal]
  }))
  .sort(
    (a,b)=>CANAL_ORDER.indexOf(a.canal) - CANAL_ORDER.indexOf(b.canal)
  );

/* =======================
   DONUT
======================= */

const svg = document.getElementById("donut");
const cx = 100, cy = 100, r = 80, w = 24;

let start = -Math.PI/2;
const total = slices.reduce((s,d)=>s+Math.abs(d.pct),0) || 1;

slices.forEach(s=>{
  const ang = (Math.abs(s.pct)/total) * Math.PI*2;
  const end = start + ang;

  const path = document.createElementNS("http://www.w3.org/2000/svg","path");
  path.setAttribute("fill","none");
  path.setAttribute("stroke",s.color);
  path.setAttribute("stroke-width",w);
  path.setAttribute("d",arc(cx,cy,r,start,end));
  path.appendChild(titleNode(`${s.label}: ${fmtPctChart(s.pct)}`));
  svg.appendChild(path);

  start = end;
});

// texto central
const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
txt.setAttribute("x",cx);
txt.setAttribute("y",cy+4);
txt.setAttribute("text-anchor","middle");
txt.setAttribute("font-size","14");
txt.textContent = fmtPctChart(
  slices.reduce((s,d)=>s+d.pct,0)
);
svg.appendChild(txt);

/* =======================
   LEGENDA
======================= */

const lg = document.getElementById("legend");
lg.innerHTML = slices.map(s=>`
  <div>
    <span style="display:inline-block;width:10px;height:10px;background:${s.color};margin-right:6px"></span>
    ${s.label}
  </div>
`).join("");

/* =======================
   TABELA
======================= */

const tb = document.getElementById("tbl");
tb.innerHTML = slices.map(s=>`
  <tr>
    <td>${s.label}</td>
    <td>${fmtPctTable(s.pct)}</td>
  </tr>
`).join("");

/* =======================
   FUNÇÕES SVG
======================= */

function arc(cx,cy,r,a0,a1){
  const x0 = cx + r*Math.cos(a0);
  const y0 = cy + r*Math.sin(a0);
  const x1 = cx + r*Math.cos(a1);
  const y1 = cy + r*Math.sin(a1);
  const f = a1-a0 > Math.PI ? 1 : 0;
  return `M ${x0} ${y0} A ${r} ${r} 0 ${f} 1 ${x1} ${y1}`;
}

function titleNode(t){
  const n = document.createElementNS("http://www.w3.org/2000/svg","title");
  n.textContent = t;
  return n;
}
</script>

</body>
</html>
