<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Mapa Leroy Merlin</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css"/>
<script src="https://js.arcgis.com/4.30/"></script>

<style>
html,body,#viewDiv{
  padding:0;
  margin:0;
  height:100%;
  width:100%;
}
</style>
</head>
<body>
<div id="viewDiv"></div>

<script>
/**************** URLs ******************/
const LOJAS_URL   ="https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const ZONAS_URL   ="https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const BAIRROS_URL ="https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";

/**************** parÃ¢metros ***************/
const params=new URLSearchParams(location.search);
const codLoja=params.get("cod_loja");

/**************** mapa ********************/
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
],(Map,MapView,FeatureLayer)=>{

const map=new Map({basemap:"streets-navigation-vector"});

const view=new MapView({
  container:"viewDiv",
  map,
  zoom:4,
  center:[-54,-14]
});

/********** LOJAS ***********/
const lojasLayer=new FeatureLayer({
  url:LOJAS_URL,
  outFields:["*"],
  title:"Lojas"
});

/********** ZONAS ***********/
const zonasLayer=new FeatureLayer({
  url:ZONAS_URL,
  definitionExpression:`COD_LOJA='${codLoja}'`,
  outFields:["*"],
  renderer:{
    type:"simple",
    symbol:{
      type:"simple-fill",
      color:[0,0,0,0],
      outline:{color:"#EE861F",width:2}
    }
  }
});

/********** BAIRROS ***********/
const bairrosLayer=new FeatureLayer({
  url:BAIRROS_URL,
  definitionExpression:`cod_loja_zinflu='${codLoja}'`,
  outFields:["*"]
});

/****** adiciona **********/
map.addMany([bairrosLayer,zonasLayer,lojasLayer]);


/*****************************************************
 * AGORA SIM GARANTO QUE O ZOOM FUNCIONA AQUI
 *****************************************************/
view.when(()=>{

  if(!codLoja || codLoja=="0"){
    console.log("Primeira abertura ou cod_loja=0");

    lojasLayer.visible=true;
    zonasLayer.visible=false;
    bairrosLayer.visible=false;

    view.goTo({
      center:[-54,-14],
      zoom:4
    });

    return;
  }

  /*************************************************
   * segue fluxo normal se cod_loja existe
   *************************************************/
  lojasLayer.when(async()=>{

    zonasLayer.visible=true;
    bairrosLayer.visible=true;

    const q=lojasLayer.createQuery();
    q.where=`cod_loja='${codLoja}'`;
    const r=await lojasLayer.queryFeatures(q);

    if(!r.features.length){
      view.goTo({center:[-54,-14],zoom:4});
      lojasLayer.visible=true;
      zonasLayer.visible=false;
      bairrosLayer.visible=false;
      return;
    }

  });

}); // fim view.when

});
</script>
</body>
</html>
