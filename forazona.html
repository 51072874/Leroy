<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=282, initial-scale=1"/>

<style>
html, body{
  margin:0;
  padding:0;
  width:282px;              /* largura fixa */
  background:#fff;
  overflow:hidden;
  font-family: Arial, Helvetica, sans-serif;
  color:#444444;
}

/* container sem altura fixa */
#container{
  position:relative;
  width:282px;
  box-sizing:border-box;
}

/* ===== LOADER ===== */
#loader{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:transparent;
  z-index:10;
}

.spinner{
  width:22px;
  height:22px;
  border:3px solid #dddddd;
  border-top-color:#2b7cff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{ to{ transform:rotate(360deg);} }

/* esconde conteúdo durante load */
.loading #content{
  visibility:hidden;
}

#content{
  width:100%;
}

/* ===== KPI ===== */
.kpiWrap{
  width:100%;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  border:1px solid #e6e6e6;
  border-radius:6px;
  overflow:hidden;
  box-sizing:border-box;
}

.kpi{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px 4px;          /* define a altura “natural” */
  box-sizing:border-box;
}

.kpi + .kpi{
  border-left:1px solid #d0d0d0;
}

.kpiValue{
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:3px;
  font-size:11px;
  font-weight:600;
  line-height:1.1;
  white-space:nowrap;
}

.kpiUnit{
  font-size:11px;
  font-weight:600;
  color:#444444;
}
</style>
</head>

<body class="loading">
<div id="container">
  <div id="loader"><div class="spinner"></div></div>

  <div id="content">
    <div class="kpiWrap" id="kpiWrap">
      <div class="kpi">
        <div class="kpiValue">
          <span class="kpiUnit">R$</span>
          <span id="vAtual">—</span>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiValue">
          <span id="vPct">—</span>
          <span class="kpiUnit">%</span>
        </div>
      </div>

      <div class="kpi">
        <div class="kpiValue">
          <span id="vProg">—</span>
          <span class="kpiUnit">%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const LAYER_URL =
 "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja:"id_loja_venda",
  mes:"mes",
  ano:"ano",
  canal:"id_canal_venda",
  secao:"secao",
  valorAtual:"valor_vendas_atual",
  valorAnterior:"valor_vendas_anterior"
};

const qs = new URLSearchParams(window.location.search);

/* ===== utils ===== */
function showLoader(on){
  document.getElementById("loader").style.display = on ? "flex":"none";
  document.body.classList.toggle("loading", on);
}

function esc(s){ return String(s).replace(/'/g,"''"); }

function list(n){
  if(!qs.has(n)) return [];
  return qs.get(n).split(",").map(v=>v.trim()).filter(Boolean);
}

function buildWhere(removeMes=false){
  const p=["1=1"];
  const lojas=list("loja"), meses=list("mes"), anos=list("ano"),
        canais=list("id_canal_venda"), secoes=list("secao");

  if(lojas.length) p.push(`${FIELDS.loja} IN (${lojas.map(v=>`'${esc(v)}'`).join(",")})`);
  if(!removeMes && meses.length) p.push(`${FIELDS.mes} IN (${meses.map(v=>`'${esc(v)}'`).join(",")})`);
  if(anos.length) p.push(`${FIELDS.ano} IN (${anos.map(v=>`'${esc(v)}'`).join(",")})`);
  if(canais.length) p.push(`${FIELDS.canal} IN (${canais.map(v=>`'${esc(v)}'`).join(",")})`);
  if(secoes.length) p.push(`${FIELDS.secao} IN (${secoes.map(v=>`'${esc(v)}'`).join(",")})`);

  return p.join(" AND ");
}

async function esriQuery(params){
  const u=new URL(LAYER_URL+"/query");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  const j=await r.json();
  if(!r.ok||j.error) throw j.error;
  return j;
}

function fmtBR(n){
  return Number(n||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
}
function fmtPct(n){
  return Number(n||0).toFixed(2).replace(".",",");
}

/* ===== Ajuste dinâmico de altura ===== */
function observeHeight(){
  const wrap = document.getElementById("kpiWrap");
  if (!wrap || !window.ResizeObserver) return;

  const ro = new ResizeObserver(() => {
    document.documentElement.style.height = wrap.offsetHeight + "px";
    document.body.style.height = wrap.offsetHeight + "px";
  });
  ro.observe(wrap);
}

/* ===== load ===== */
async function load(){
  showLoader(true);

  const wSel=buildWhere(false), wAll=buildWhere(true);

  const sel=await esriQuery({
    f:"json", where:wSel,
    outStatistics:JSON.stringify([
      {statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"A"},
      {statisticType:"sum", onStatisticField:FIELDS.valorAnterior, outStatisticFieldName:"B"}
    ]),
    returnGeometry:"false"
  });

  const all=await esriQuery({
    f:"json", where:wAll,
    outStatistics:JSON.stringify([
      {statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"T"}
    ]),
    returnGeometry:"false"
  });

  const a=sel.features?.[0]?.attributes||{};
  const b=all.features?.[0]?.attributes||{};

  const atual=+a.A||0, ant=+a.B||0, total=+b.T||0;

  document.getElementById("vAtual").textContent = fmtBR(atual);
  document.getElementById("vPct").textContent   = fmtPct(total ? (atual/total)*100 : 0);
  document.getElementById("vProg").textContent  = fmtPct(ant ? ((atual/ant)-1)*100 : 0);

  showLoader(false);
  observeHeight();
}

load();
</script>
</body>
</html>
