<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  width:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  overflow:hidden;
}
.titleBar{
  background:#6FAFB3;
  color:#fff;
  text-align:center;
  padding:6px;
  font-weight:600;
}
.wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.topRow{
  display:flex;
  gap:16px;
  align-items:center;
}
.chartBox{
  width:220px;
  height:220px;
}
svg{ width:100%; height:100%; overflow:visible; }

.legend{
  display:flex;
  gap:14px;
  font-size:11px;
}
.legItem{
  display:flex;
  gap:6px;
  align-items:center;
}
.swatch{
  width:12px;
  height:12px;
  border-radius:3px;
}

.tableBox{
  border:1px solid #d1d5db;
  border-radius:6px;
  overflow:hidden;
}
table{
  border-collapse:collapse;
  font-size:11px;
}
th,td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
}
th{ background:#f9fafb; text-align:left; }
td:last-child, th:last-child{ text-align:right; }

.pctLabel{
  font-size:8px;
  font-weight:600;
  fill:#111827;
}
</style>
</head>

<body>
<div class="titleBar">Canais 1P</div>

<div class="wrap">
  <div class="topRow">
    <div class="chartBox">
      <svg id="donut" viewBox="0 0 100 100"></svg>
    </div>

    <div class="tableBox">
      <table>
        <thead>
          <tr><th>Canal</th><th>Prog %</th></tr>
        </thead>
        <tbody id="progBody"></tbody>
      </table>
    </div>
  </div>

  <div class="legend" id="legend"></div>
</div>

<script>
/* ================= CONFIG ================= */

const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  canal: "id_canal_venda",
  valorAtual: "valor_vendas_atual",
  valorAnterior: "valor_vendas_anterior"
};

const CANAL_LABEL = {
  "0": "E-commerce",
  "1": "Loja FÃ­sica",
  "2": "Televendas"
};

const COLORS = {
  "0": "#1F5A78",
  "1": "#0B2E3F",
  "2": "#F28C38"
};

/* ================= QUERY ================= */

async function esriQuery(params){
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  const r = await fetch(url);
  const j = await r.json();
  if (j.error) throw j.error;
  return j;
}

/* ================= LOAD ================= */

async function load(){
  const q = await esriQuery({
    f:"json",
    where:"cod_loja_zinflu2 IS NOT NULL AND cod_loja_zinflu2 <> '0'",
    groupByFieldsForStatistics:FIELDS.canal,
    outStatistics: JSON.stringify([
      { statisticType:"sum", onStatisticField:FIELDS.valorAtual, outStatisticFieldName:"ATUAL" },
      { statisticType:"sum", onStatisticField:FIELDS.valorAnterior, outStatisticFieldName:"ANT" }
    ]),
    returnGeometry:"false"
  });

  const rows = q.features.map(f=>{
    const c = f.attributes[FIELDS.canal];
    return {
      canal:c,
      label:CANAL_LABEL[c],
      atual:f.attributes.ATUAL,
      ant:f.attributes.ANT,
      color:COLORS[c]
    };
  });

  render(rows);
}

/* ================= RENDER ================= */

function render(data){
  const svg = document.getElementById("donut");
  const tb  = document.getElementById("progBody");
  const lg  = document.getElementById("legend");

  svg.innerHTML="";
  tb.innerHTML="";
  lg.innerHTML="";

  const cx=50, cy=50, rO=46, rI=28;
  const total = data.reduce((s,d)=>s+d.atual,0);

  let angle = -90;

  data.forEach(d=>{
    const pct = d.atual / total;
    const delta = pct * 360;

    const a0 = angle * Math.PI/180;
    const a1 = (angle+delta) * Math.PI/180;

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("fill", d.color);
    path.setAttribute("d",`
      M ${cx+rO*Math.cos(a1)} ${cy+rO*Math.sin(a1)}
      A ${rO} ${rO} 0 ${delta>180?1:0} 0 ${cx+rO*Math.cos(a0)} ${cy+rO*Math.sin(a0)}
      L ${cx+rI*Math.cos(a0)} ${cy+rI*Math.sin(a0)}
      A ${rI} ${rI} 0 ${delta>180?1:0} 1 ${cx+rI*Math.cos(a1)} ${cy+rI*Math.sin(a1)}
      Z
    `);
    svg.appendChild(path);

    angle += delta;
  });

  data.forEach(d=>{
    const prog = (d.ant === 0)
      ? 0
      : ((d.atual - d.ant) / d.ant) * 100; // <<< AJUSTE

    tb.innerHTML += `
      <tr>
        <td>${d.label}</td>
        <td>${prog.toFixed(2).replace(".",",")}%</td>
      </tr>
    `;

    lg.innerHTML += `
      <div class="legItem">
        <span class="swatch" style="background:${d.color}"></span>
        <span>${d.label}</span>
      </div>
    `;
  });
}

load();
</script>
</body>
</html>
