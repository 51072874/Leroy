<!doctype html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{margin:0;font-family:Arial}
#container{padding:12px}
.title{
  text-align:center;
  font-weight:600;
  margin-bottom:12px;
}
.bar{
  background:#4F7987;
  height:24px;
  margin:6px 0;
  color:#fff;
  padding:0 8px;
  line-height:24px;
  border-radius:4px;
  white-space:nowrap;
}
</style>
</head>

<body>
<div id="container">
  <div class="title">PDM / PROG</div>
  <div id="out"></div>
</div>

<script>
/* ========= JSONP ========= */

function esriJSONP(url, params){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    params.f="json";
    params.callback=cb;

    const qs=Object.entries(params)
      .map(([k,v])=>k+"="+encodeURIComponent(v))
      .join("&");

    const s=document.createElement("script");
    s.src=url+"/query?"+qs;

    window[cb]=data=>{
      delete window[cb];
      s.remove();
      resolve(data);
    };

    s.onerror=()=>{
      delete window[cb];
      s.remove();
      reject("JSONP error");
    };

    document.body.appendChild(s);
  });
}

/* ========= LOAD ========= */

async function load(){

  const res = await esriJSONP(
    "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/3",
    {
      where: "vendas_brutas IS NOT NULL",
      groupByFieldsForStatistics: "isocrona",
      outStatistics: JSON.stringify([{
        statisticType: "sum",
        onStatisticField: "vendas_brutas",
        outStatisticFieldName: "VB"
      }]),
      outFields: "*",
      returnGeometry: false
    }
  );

  console.log("Resposta:", res);

  if(!res.features || !res.features.length){
    document.getElementById("out").innerHTML =
      "<b>Sem dados retornados</b>";
    return;
  }

  const total = res.features
    .reduce((s,f)=>s+Number(f.attributes.VB||0),0);

  document.getElementById("out").innerHTML =
    res.features.map(f=>{
      const v = f.attributes.VB;
      const p = ((v/total)*100).toFixed(1);
      return `<div class="bar">
        ${f.attributes.isocrona} â€“ ${p}%
      </div>`;
    }).join("");
}

load();
</script>
</body>
</html>
