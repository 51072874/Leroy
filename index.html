<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Mapa Leroy Merlin</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css"/>
<script src="https://js.arcgis.com/4.30/"></script>

<style>
html,body,#viewDiv {
  padding:0;
  margin:0;
  width:100%;
  height:100%;
}
</style>
</head>

<body>
<div id="viewDiv"></div>

<script>

// ---------------- URLs ----------------
const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";


// ---------- parâmetros URL -----------
const p = new URLSearchParams(location.search);
const codLoja = p.get("cod_loja");
const secao   = p.get("secao");
const canal   = p.get("id_canal_venda");
const ano     = p.get("ano");
const mes     = p.get("mes");


// ---------- Mapa ----------
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer"
], function(Map,MapView,FeatureLayer){

  const map = new Map({ basemap:"streets-navigation-vector" });

  const view = new MapView({
    container:"viewDiv",
    map,
    center:[-46.63,-23.55],
    zoom:11
  });


  // ---------- Camada Bairros ----------
  const bairros = new FeatureLayer({
    url:BAIRROS_URL,
    outFields:["*"],
    title:"Bairros",
    definitionExpression:`cod_loja_zinflu='${codLoja}'`
  });

  // ---------- Camada Zona ----------
  const zonas = new FeatureLayer({
    url:ZONAS_URL, outFields:["*"],
    title:"Zonas",
    definitionExpression:`COD_LOJA='${codLoja}'`
  });

  // ---------- Camada Lojas ----------
  const lojas = new FeatureLayer({
    url:LOJAS_URL, outFields:["*"],
    title:"Lojas",
    definitionExpression:`cod_loja='${codLoja}'`
  });

  map.addMany([bairros,zonas,lojas]);


  // ==============================
  // PROCESSAMENTO PRINCIPAL
  // ==============================

  bairros.when(async()=>{

      // consulta bairros
      const q = bairros.createQuery();
      q.where = `cod_loja_zinflu='${codLoja}'`;
      q.returnGeometry = true;
      q.outFields = ["cod_bairro"];

      const r = await bairros.queryFeatures(q);
      if(!r.features.length) return;

      // zoom
      try{
        await view.goTo(r.features.map(f=>f.geometry.extent));
      }catch{}

      // monta lista IDs
      const listaIDs = r.features.map(
        f=> `'${f.attributes.cod_bairro}'`
      ).join(",");

      // --------------------------------
      // filtros extras
      let filtroExtra="";
      let whereV = `id_bairro_cep IN (${listaIDs})`;

      if(secao) filtroExtra += ` AND secao='${secao}'`;
      if(canal) filtroExtra += ` AND id_canal_venda='${canal}'`;
      if(ano)   filtroExtra += ` AND ano=${ano}`;
      if(mes)   filtroExtra += ` AND mes=${mes}`;

      whereV += filtroExtra;


      // ---------- Query vendas ----------
      const vendas = new FeatureLayer({url:VENDAS_URL});

      const qv = vendas.createQuery();
      qv.where = whereV;
      qv.outFields = ["id_bairro_cep","valor_vendas_atual","valor_vendas_anterior"];

      const rv = await vendas.queryFeatures(qv);

      // calcula progressão
      const prog={};

      rv.features.forEach(f=>{
        const a = f.attributes.valor_vendas_atual||0;
        const b = f.attributes.valor_vendas_anterior||0;
        prog[f.attributes.id_bairro_cep] = (b!==0)?((a/b)-1)*100:0;
      });

      // aplica cor
      bairros.renderer = {
        type:"simple",
        symbol:{type:"simple-fill"},
        visualVariables:[{
          type:"color",
          valueExpression:`var p=${JSON.stringify(prog)}; return DefaultValue(p[$feature.cod_bairro],0);`,
          stops:[
            {value:-20,color:"#c00"},
            {value:-10,color:"#f66"},
            {value:0,color:"#f7a"},
            {value:10,color:"#7ff"},
            {value:20,color:"#0cc"},
            {value:100,color:"#088"}
          ]
        }]
      };

      bairros.refresh();
  });

});

</script>
</body>
</html>
