<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
  :root{
    --bg:#ffffff;
    --text:#111827;
    --pad:10px;
  }

  html, body{
    margin:0;
    padding:0;
    height:100%;
    background:var(--bg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
  }

  #container{
    position:relative;
    height:100%;
    width:100%;
    padding:var(--pad);
    box-sizing:border-box;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #loader{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10;
    pointer-events:none;
  }

  .spinner{
    width:clamp(28px, 6vw, 42px);
    height:clamp(28px, 6vw, 42px);
    border:clamp(3px, .6vw, 4px) solid #ddd;
    border-top-color:#2b7cff;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }

  @keyframes spin{ to{ transform:rotate(360deg); } }

  .kpiValue{
    font-weight:800;
    line-height:1.05;
    font-variant-numeric: tabular-nums;
    white-space:nowrap;
    visibility:hidden;
    font-size:clamp(12px, 6.5vw, 40px);
    max-width:100%;
    overflow:hidden;
    text-overflow:ellipsis;
  }
</style>
</head>

<body>
<div id="container">
  <div id="loader"><div class="spinner"></div></div>
  <div id="kpiValue" class="kpiValue"></div>
</div>

<script>
/* ================= CONFIG ================= */

const LAYER_URL =
  "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  codZ: "cod_loja_zinflu2",
  clientesAtual: "clientes_atual",
  clientesAnterior: "clientes_anterior"
};

/* ================= FILTROS ================= */

// Armazena o SQL atual do widget de filtro
let currentSQLWhere = null;

// üéØ ESCUTAR MENSAGENS DO WIDGET DE FILTRO
window.addEventListener('message', function(event) {
  if (event.data.type === 'SPOTX_FILTER_CHANGE' && event.data.filters) {
    console.log('üì© KPI Clientes % recebeu filtros:', event.data.filters);
    
    if (event.data.filters.sqlWhere) {
      currentSQLWhere = event.data.filters.sqlWhere;
      console.log('üîç SQL aplicado no KPI Clientes %:', currentSQLWhere);
      
      // Recarregar KPI com o novo filtro
      load();
    }
  }
});

/* ================= UTIL ================= */

const qs = new URLSearchParams(window.location.search);

function showLoader(on){
  document.getElementById("loader").style.display = on ? "flex" : "none";
}

function escapeSqlString(s){
  return String(s).replace(/'/g, "''");
}

function parseList(name){
  if (!qs.has(name)) return [];
  return String(qs.get(name) || "")
    .split(",")
    .map(v => v.trim())
    .filter(v => v !== "");
}

function buildWhere(){
  // üéØ PRIORIDADE 1: Usar SQL do widget de filtro
  if (currentSQLWhere && currentSQLWhere !== "1=1") {
    let sqlBase = currentSQLWhere;
    
    // Adicionar filtro fixo cod_loja_zinflu2
    const fixedFilters = [
      `${FIELDS.codZ} IS NOT NULL`,
      `${FIELDS.codZ} <> '0'`
    ];
    
    const finalSQL = `${sqlBase} AND ${fixedFilters.join(" AND ")}`;
    console.log("‚úÖ SQL KPI Clientes %:", finalSQL);
    return finalSQL;
  }

  // üéØ PRIORIDADE 2: Usar par√¢metros da URL (fallback)
  const parts = ["1=1"];
  parts.push(`${FIELDS.codZ} IS NOT NULL`);
  parts.push(`${FIELDS.codZ} <> '0'`);

  const lojas  = parseList("loja");
  const meses  = parseList("mes");
  const anos   = parseList("ano");
  const canais = parseList("id_canal_venda");
  const secoes = parseList("secao");

  if (lojas.length)
    parts.push(`${FIELDS.loja} IN (${lojas.map(v => `'${escapeSqlString(v)}'`).join(",")})`);

  if (meses.length)
    parts.push(`${FIELDS.mes} IN (${meses.map(v => `'${escapeSqlString(v)}'`).join(",")})`);

  if (anos.length)
    parts.push(`${FIELDS.ano} IN (${anos.map(v => `'${escapeSqlString(v)}'`).join(",")})`);

  if (canais.length)
    parts.push(`${FIELDS.canal} IN (${canais.map(v => `'${escapeSqlString(v)}'`).join(",")})`);

  if (secoes.length)
    parts.push(`${FIELDS.secao} IN (${secoes.map(v => `'${escapeSqlString(v)}'`).join(",")})`);

  return parts.join(" AND ");
}

async function esriQuery(params){
  const url = new URL(LAYER_URL.replace(/\/+$/,"") + "/query");
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  const r = await fetch(url.toString());
  const j = await r.json();
  if (!r.ok || j.error) throw (j.error || { message:`HTTP ${r.status}` });
  return j;
}

function fmtBR(n){
  if (!isFinite(n)) n = 0;
  return n.toFixed(2).replace(".", ",");
}

/* ================= LOAD ================= */

async function load(){
  showLoader(true);

  try {
    const where = buildWhere();

    const q = await esriQuery({
      f: "json",
      where,
      outStatistics: JSON.stringify([
        { statisticType:"sum", onStatisticField:FIELDS.clientesAtual,    outStatisticFieldName:"TOTAL_ATUAL" },
        { statisticType:"sum", onStatisticField:FIELDS.clientesAnterior, outStatisticFieldName:"TOTAL_ANTERIOR" }
      ]),
      returnGeometry:"false"
    });

    const atual    = Number(q.features?.[0]?.attributes?.TOTAL_ATUAL || 0);
    const anterior = Number(q.features?.[0]?.attributes?.TOTAL_ANTERIOR || 0);

    const progressao = anterior === 0 ? 0 : (atual / anterior) * 100;

    const el = document.getElementById("kpiValue");
    el.textContent = `${fmtBR(progressao)}%`;
    el.style.visibility = "visible";

  } catch(e) {
    console.error("‚ùå Erro ao carregar KPI Clientes %:", e);
    const el = document.getElementById("kpiValue");
    el.textContent = "Erro";
    el.style.visibility = "visible";
  }

  showLoader(false);
}

// Carregar dados iniciais
load();

// Debug
console.log("üéØ KPI Clientes % pronto para receber filtros via postMessage");
</script>
</body>
</html>
