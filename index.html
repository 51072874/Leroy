<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapa Leroy Merlin</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>
  <style>
    html, body, #viewDiv {
      padding: 0; margin: 0; height: 100%; width: 100%;
    }
  </style>
</head>
<body>
<div id="viewDiv"></div>
<script>
/**********************************************
 * URLs das camadas (ajuste se necessário)
 *********************************************/
const LOJAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/0";
const ZONAS_URL   = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/1";
const BAIRROS_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/2";
const VENDAS_URL  = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

/**********************************************
 * ler parâmetros (query string)
 *********************************************/
const params = new URLSearchParams(window.location.search);
let codLoja = params.get("cod_loja");
const secao   = params.get("secao");
const idCanal = params.get("id_canal_venda");
const ano     = params.get("ano");
const mes     = params.get("mes");

// normaliza valores vazios/indefinidos para "0" (modo Brasil)
if(!codLoja || codLoja === "" || codLoja === "null" || codLoja === "undefined"){
  codLoja = "0";
}
console.log("PARAMS:", { codLoja, secao, idCanal, ano, mes });

/**********************************************
 * main - require
 *********************************************/
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/geometry/Extent"
], function(Map, MapView, FeatureLayer, Extent) {

  const map = new Map({ basemap: "streets-navigation-vector" });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    // fallback inicial (Brasil)
    center: [-54, -14],
    zoom: 4
  });

  // criar layers (visibilidade controlada dinamicamente)
  const bairrosLayer = new FeatureLayer({
    url: BAIRROS_URL,
    outFields: ["cod_bairro"],
    title: "Bairros",
    visible: true
  });

  const zonasLayer = new FeatureLayer({
    url: ZONAS_URL,
    outFields: ["*"],
    title: "Zonas",
    visible: true,
    renderer: {
      type: "simple",
      symbol: {
        type: "simple-fill",
        color: [0,0,0,0],
        outline: { color: "#EE861F", width: 2 }
      }
    }
  });

  const lojasLayer = new FeatureLayer({
    url: LOJAS_URL,
    outFields: ["*"],
    title: "Lojas",
    visible: true
  });

  map.addMany([bairrosLayer, zonasLayer, lojasLayer]);

  // helper: calcula extent agregado a partir de array de features (geometries extents)
  function aggregateExtentFromFeatures(features){
    if(!features || !features.length) return null;
    let xmin = Infinity, ymin = Infinity, xmax = -Infinity, ymax = -Infinity;
    features.forEach(f => {
      const e = f.geometry && f.geometry.extent;
      if(!e) return;
      if(e.xmin < xmin) xmin = e.xmin;
      if(e.ymin < ymin) ymin = e.ymin;
      if(e.xmax > xmax) xmax = e.xmax;
      if(e.ymax > ymax) ymax = e.ymax;
    });
    if(xmin === Infinity) return null;
    return new Extent({ xmin, ymin, xmax, ymax, spatialReference: { wkid: 4326 } });
  }

  // modo Brasil (cod_loja === "0")
  if(codLoja === "0"){
    console.log("[MODE] Brasil: mostrando somente lojas (todas)");
    bairrosLayer.visible = false;
    zonasLayer.visible  = false;
    lojasLayer.visible  = true;
    try { lojasLayer.definitionExpression = "1=1"; } catch(e){ console.warn(e); }

    // extent Brasil (bem afastado)
    const brasilExtent = new Extent({ xmin:-82, ymin:-35, xmax:-32, ymax:10, spatialReference:{wkid:4326} });
    view.goTo({ extent: brasilExtent }).catch(e => console.warn("goTo Brasil falhou:", e));
    // não processa bairros/vendas
    return;
  }

  // ---------- fluxo para codLoja != "0" ----------
  (async function processStore(){
    try{
      console.log("[FLOW] Iniciando processamento para loja:", codLoja);

      // carrega as layers
      await lojasLayer.load();
      await bairrosLayer.load();
      await zonasLayer.load();

      // aplica definitionExpression (filtra as layers pelo codLoja)
      lojasLayer.definitionExpression = `cod_loja = '${codLoja}'`;
      zonasLayer.definitionExpression  = `COD_LOJA = '${codLoja}'`;
      bairrosLayer.definitionExpression = `cod_loja_zinflu = '${codLoja}'`;

      // verifica se a loja existe
      const qLoja = lojasLayer.createQuery();
      qLoja.where = `cod_loja = '${codLoja}'`;
      qLoja.returnGeometry = true; // se quiser centralizar na geometria da loja
      qLoja.outFields = ["*"];
      const rLoja = await lojasLayer.queryFeatures(qLoja);
      console.log("rLoja found:", rLoja.features.length);

      if(!rLoja.features.length){
        console.warn("Loja não encontrada. Voltando para modo Brasil (exibir lojas).");
        bairrosLayer.visible = false;
        zonasLayer.visible  = false;
        lojasLayer.visible  = true;
        try { lojasLayer.definitionExpression = "1=1"; } catch(e){}
        const brasilExtent = new Extent({ xmin:-82, ymin:-35, xmax:-32, ymax:10, spatialReference:{wkid:4326} });
        await view.goTo({ extent: brasilExtent });
        return;
      }

      // buscar bairros que influenciam a loja
      const q = bairrosLayer.createQuery();
      q.where = `cod_loja_zinflu = '${codLoja}'`;
      q.returnGeometry = true;
      q.outFields = ["cod_bairro"];
      const r = await bairrosLayer.queryFeatures(q);
      console.log("bairros encontrados:", r.features.length);

      if(!r.features.length){
        console.warn("Nenhum bairro encontrado para cod_loja =", codLoja);
        // tentar centralizar na loja
        try {
          const lojaGeom = rLoja.features[0].geometry;
          if(lojaGeom){
            await view.goTo({ target: lojaGeom, zoom: 13 });
            return;
          }
        } catch(e){ console.warn("centralizar na loja falhou:", e); }
        return;
      }

      // calcular extent agregado e aplicar goTo (mais confiável)
      const aggExtent = aggregateExtentFromFeatures(r.features);
      if(aggExtent){
        console.log("Indo para extent agregado dos bairros");
        await view.goTo({ extent: aggExtent });
      } else {
        console.log("Extent agregado não foi calculado; pulando goTo por bairros.");
      }

      // consulta vendas com filtros extras
      const listaIDs = r.features.map(f => `'${f.attributes.cod_bairro}'`).join(",");
      const vendasLayer = new FeatureLayer({ url: VENDAS_URL });
      await vendasLayer.load();

      const filtros = [];
      if(secao) filtros.push(`secao = '${secao}'`);
      if(idCanal) filtros.push(`id_canal_venda = '${idCanal}'`);
      if(ano) filtros.push(`ano = ${Number(ano)}`);
      if(mes) filtros.push(`mes = ${Number(mes)}`);
      const filtroExtra = filtros.length ? " AND " + filtros.join(" AND ") : "";

      const qv = vendasLayer.createQuery();
      qv.where = `id_bairro_cep IN (${listaIDs})${filtroExtra}`;
      qv.outFields = ["id_bairro_cep","valor_vendas_atual","valor_vendas_anterior"];
      qv.returnGeometry = false;

      console.log("Consultando vendas com where:", qv.where);
      const vendasData = await vendasLayer.queryFeatures(qv);
      console.log("vendas features:", vendasData.features.length);

      // montar progresso por bairro
      const progresso = {};
      vendasData.features.forEach(f => {
        const atual = f.attributes.valor_vendas_atual || 0;
        const anterior = f.attributes.valor_vendas_anterior || 0;
        let pct = 0;
        if (anterior !== 0) pct = ((atual / anterior) - 1) * 100;
        progresso[f.attributes.id_bairro_cep] = pct;
      });

      // aplicar renderer com visualVariables
      bairrosLayer.renderer = {
        type: "simple",
        symbol: {
          type: "simple-fill",
          outline: { color: "#777", width: 0.5 }
        },
        visualVariables: [
          {
            type: "color",
            valueExpression: `
              var pg = ${JSON.stringify(progresso)};
              var v = pg[$feature.cod_bairro];
              return DefaultValue(v, 0);
            `,
            stops: [
              { value: -20, color: "rgba(192,0,0,0.3)" },
              { value: -10, color: "rgba(255,63,63,0.3)" },
              { value: 0,   color: "rgba(244,146,75,0.3)" },
              { value: 10,  color: "rgba(127,255,255,0.3)" },
              { value: 20,  color: "rgba(0,192,192,0.3)" },
              { value: 100, color: "rgba(0,128,128,0.3)" }
            ]
          }
        ]
      };

      bairrosLayer.refresh();
      console.log("Renderer aplicado e camada atualizada.");

    } catch(err){
      console.error("Erro no processamento por loja:", err);
    }
  })();

}); // end require
</script>
</body>
</html>
