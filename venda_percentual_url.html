<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gr√°fico SpotX - Vendas por Classe Social</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}

#container {
  position: relative;
  height: 100%;
  width: 100%;
}

#filtrosAtivos {
  display: none;
  padding: 12px;
  background: #e3f2fd;
  border-bottom: 2px solid #1976d2;
  font-size: 13px;
  color: #1976d2;
}

#filtrosAtivos strong {
  font-weight: 600;
}

#loader {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.9);
  z-index: 10;
}

.spinner {
  width: 42px;
  height: 42px;
  border: 4px solid #ddd;
  border-top-color: #2b7cff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 12px;
  font-size: 14px;
  color: #666;
}

canvas {
  width: 100% !important;
  height: 100% !important;
}

#nodata {
  display: none;
  position: absolute;
  inset: 0;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  font: 14px system-ui;
  color: #666;
}

#nodata svg {
  width: 64px;
  height: 64px;
  margin-bottom: 12px;
  opacity: 0.3;
}
</style>
</head>

<body>
<div id="container">
  <!-- Filtros Ativos -->
  <div id="filtrosAtivos">
    <strong>üîç Filtros Ativos:</strong> <span id="filtrosTexto">Nenhum</span>
  </div>

  <!-- Loading -->
  <div id="loader">
    <div class="spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <!-- Gr√°fico -->
  <canvas id="chart"></canvas>

  <!-- Sem Dados -->
  <div id="nodata">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </svg>
    <div>Nenhum dado dispon√≠vel para os filtros selecionados</div>
  </div>
</div>

<script>
// ============================================
// CONFIGURA√á√ïES
// ============================================
const LAYER_URL = "https://igeo.leroymerlin.com.br/server/rest/services/Hosted/One_Page_SpotX/FeatureServer/8";

// Estado global dos filtros
let FILTERS = {
  loja: [],
  mes: [],
  ano: [],
  secao: [],
  id_canal_venda: []
};

// Mapeamento de campos do Feature Service
const FIELDS = {
  loja: "id_loja_venda",
  mes: "mes",
  ano: "ano",
  canal: "id_canal_venda",
  secao: "secao",
  classe: "classe_social",
  valor: "valor_vendas_atual"
};

// Cores para cada classe social
const CLASS_COLORS = {
  "A1": "#0B2C3D",
  "A2": "#1F4E66",
  "B1": "#2E6B3F",
  "B2": "#6FAF8E",
  "C1": "#F2D36B",
  "C2": "#F6E8B1",
  "D/E": "#D9D9D9"
};

// Collator para ordena√ß√£o brasileira
const collator = new Intl.Collator("pt-BR", { numeric: true, sensitivity: "base" });

// ============================================
// FUN√á√ïES AUXILIARES
// ============================================

function showLoader(on) {
  document.getElementById("loader").style.display = on ? "flex" : "none";
}

function showNoData(show) {
  document.getElementById("nodata").style.display = show ? "flex" : "none";
}

function toArray(v) {
  if (!v) return [];
  if (Array.isArray(v)) return v.map(String);
  return String(v).split(",").map(s => s.trim()).filter(Boolean);
}

function fmtPctBR(n) {
  if (!isFinite(n)) return "0,00%";
  return n.toFixed(2).replace(".", ",") + "%";
}

// ============================================
// CONSTRU√á√ÉO DA CL√ÅUSULA WHERE
// ============================================

function buildWhere() {
  const parts = ["1=1"];

  if (FILTERS.loja.length) {
    parts.push(`id_loja_venda IN (${FILTERS.loja.map(v => `'${v}'`).join(",")})`);
  }

  if (FILTERS.mes.length) {
    parts.push(`mes IN (${FILTERS.mes.map(v => `'${v}'`).join(",")})`);
  }

  if (FILTERS.ano.length) {
    parts.push(`ano IN (${FILTERS.ano.map(v => `'${v}'`).join(",")})`);
  }

  if (FILTERS.secao.length) {
    parts.push(`secao IN (${FILTERS.secao.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);
  }

  if (FILTERS.id_canal_venda.length) {
    parts.push(`id_canal_venda IN (${FILTERS.id_canal_venda.map(v => `'${v.replace(/'/g,"''")}'`).join(",")})`);
  }

  const whereFinal = parts.join(" AND ");
  console.log("üß© WHERE FINAL:", whereFinal);

  return whereFinal;
}

// ============================================
// REQUISI√á√ÉO AO FEATURE SERVICE
// ============================================

async function esriQuery(params) {
  const url = new URL(LAYER_URL + "/query");
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

  console.log("üåê URL da query:", url.toString());

  const response = await fetch(url.toString());
  const data = await response.json();

  if (!response.ok || data.error) {
    throw data.error || { message: "Erro na query" };
  }

  return data;
}

// ============================================
// ATUALIZA√á√ÉO DOS FILTROS ATIVOS (UI)
// ============================================

function atualizarFiltrosAtivos() {
  const ativos = [];

  if (FILTERS.loja.length) {
    ativos.push(`Loja: ${FILTERS.loja.join(', ')}`);
  }

  if (FILTERS.mes.length) {
    const mesesNomes = FILTERS.mes.map(m => {
      const nomes = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      return nomes[parseInt(m)] || m;
    });
    ativos.push(`Meses: ${mesesNomes.join(', ')}`);
  }

  if (FILTERS.ano.length) {
    ativos.push(`Ano: ${FILTERS.ano.join(', ')}`);
  }

  if (FILTERS.secao.length) {
    ativos.push(`Se√ß√µes: ${FILTERS.secao.join(', ')}`);
  }

  if (FILTERS.id_canal_venda.length) {
    ativos.push(`Canais: ${FILTERS.id_canal_venda.join(', ')}`);
  }

  const filtrosDiv = document.getElementById('filtrosAtivos');
  const filtrosTexto = document.getElementById('filtrosTexto');

  if (ativos.length > 0) {
    filtrosDiv.style.display = 'block';
    filtrosTexto.textContent = ativos.join(' | ');
  } else {
    filtrosDiv.style.display = 'none';
    filtrosTexto.textContent = 'Nenhum';
  }
}

// ============================================
// PLUGIN CHART.JS - LABELS DE VALOR
// ============================================

const valueLabelsPlugin = {
  id: "valueLabelsPlugin",
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const data = chart.data.datasets[0].data || [];

    ctx.save();
    ctx.font = "bold 12px system-ui";
    ctx.fillStyle = "#333";
    ctx.textBaseline = "middle";

    meta.data.forEach((bar, i) => {
      const v = data[i]?.x ?? 0;
      ctx.fillText(fmtPctBR(v), bar.x + 8, bar.y);
    });

    ctx.restore();
  }
};

// ============================================
// INICIALIZA√á√ÉO DO GR√ÅFICO
// ============================================

const chart = new Chart(document.getElementById("chart"), {
  type: "bar",
  data: {
    datasets: [{
      data: [],
      backgroundColor: [],
      borderWidth: 0,
      barThickness: 30
    }]
  },
  options: {
    indexAxis: "y",
    responsive: true,
    maintainAspectRatio: false,
    animation: {
      duration: 750,
      easing: 'easeInOutQuart'
    },
    parsing: { xAxisKey: "x", yAxisKey: "y" },
    layout: { 
      padding: { 
        right: 80,
        left: 10,
        top: 10,
        bottom: 10
      } 
    },
    scales: {
      x: {
        beginAtZero: true,
        grid: { 
          display: true,
          color: 'rgba(0,0,0,0.05)'
        },
        ticks: {
          callback: v => v + "%",
          font: {
            size: 11
          }
        }
      },
      y: {
        grid: { display: false },
        ticks: { 
          autoSkip: false,
          font: {
            size: 12,
            weight: 'bold'
          }
        }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  },
  plugins: [valueLabelsPlugin]
});

// ============================================
// CARREGAR E RENDERIZAR DADOS
// ============================================

async function load() {
  showLoader(true);
  showNoData(false);

  try {
    const where = buildWhere();

    // Query 1: Total por classe
    const byClass = await esriQuery({
      f: "json",
      where,
      outFields: FIELDS.classe,
      groupByFieldsForStatistics: FIELDS.classe,
      outStatistics: JSON.stringify([
        { 
          statisticType: "sum", 
          onStatisticField: FIELDS.valor, 
          outStatisticFieldName: "SUM_V" 
        }
      ]),
      returnGeometry: "false"
    });

    // Query 2: Total geral
    const totalQ = await esriQuery({
      f: "json",
      where,
      outStatistics: JSON.stringify([
        { 
          statisticType: "sum", 
          onStatisticField: FIELDS.valor, 
          outStatisticFieldName: "TOTAL" 
        }
      ]),
      returnGeometry: "false"
    });

    const total = totalQ.features?.[0]?.attributes?.TOTAL || 0;

    const rows = (byClass.features || [])
      .map(f => ({
        classe: String(f.attributes[FIELDS.classe] || "").trim(),
        valor: Number(f.attributes.SUM_V || 0)
      }))
      .filter(r => r.classe);

    console.log("üìä Dados carregados:", rows.length, "classes", "| Total:", total);

    if (!rows.length || total === 0) {
      showNoData(true);
      chart.data.datasets[0].data = [];
      chart.update();
    } else {
      showNoData(false);
      
      // Ordena por classe
      rows.sort((a, b) => collator.compare(a.classe, b.classe));
      
      // Prepara dados do gr√°fico
      chart.data.datasets[0].data = rows.map(r => ({
        y: r.classe,
        x: (r.valor / total) * 100
      }));

      chart.data.datasets[0].backgroundColor = rows.map(r => CLASS_COLORS[r.classe] || "#999");

      // Define escala m√°xima
      const maxPct = Math.max(...rows.map(r => (r.valor / total) * 100));
      chart.options.scales.x.max = Math.ceil(maxPct / 5) * 5;

      chart.update();
    }
  } catch (error) {
    console.error("‚ùå Erro ao carregar dados:", error);
    showNoData(true);
  } finally {
    showLoader(false);
  }
}

// ============================================
// LISTENER DE MENSAGENS (FILTROS DO WIDGET)
// ============================================

window.addEventListener("message", (event) => {
  const msg = event.data || {};
  
  console.log("üì® Mensagem recebida:", msg);
  
  // Aceita tanto EXB_SET_FILTER quanto SPOTX_FILTER_CHANGE
  if (msg.type === "EXB_SET_FILTER" || msg.type === "SPOTX_FILTER_CHANGE") {
    const filters = msg.filters || {};
    
    console.log("‚úÖ Filtros recebidos:", filters);
    
    // Mapeia os filtros (aceita cod_loja ou loja)
    FILTERS = {
      loja: toArray(filters.cod_loja || filters.loja),
      mes: toArray(filters.mes),
      ano: toArray(filters.ano),
      secao: toArray(filters.secao),
      id_canal_venda: toArray(filters.id_canal_venda)
    };
    
    console.log("üîß FILTERS convertidos:", FILTERS);
    
    // Atualiza UI de filtros
    atualizarFiltrosAtivos();
    
    // Recarrega o gr√°fico
    load();
  }
});

// ============================================
// CARREGAR FILTROS DA URL
// ============================================

function loadFromURL() {
  const qs = new URLSearchParams(window.location.search);
  
  FILTERS = {
    loja: toArray(qs.get("loja") || qs.get("cod_loja")),
    mes: toArray(qs.get("mes")),
    ano: toArray(qs.get("ano")),
    secao: toArray(qs.get("secao")),
    id_canal_venda: toArray(qs.get("id_canal_venda"))
  };
  
  console.log("üåê Filtros da URL:", FILTERS);
  
  atualizarFiltrosAtivos();
  load();
}

// ============================================
// INICIALIZA√á√ÉO
// ============================================

// Carrega dados iniciais (com filtros da URL, se houver)
loadFromURL();

console.log("‚úÖ Gr√°fico carregado e pronto para receber filtros do widget!");
console.log("üì° Aguardando mensagens do tipo 'EXB_SET_FILTER' ou 'SPOTX_FILTER_CHANGE'");
</script>
</body>
</html>
